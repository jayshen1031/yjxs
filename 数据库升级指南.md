# 数据库升级指南

## 📌 升级目的

将现有的Notion八数据库升级到支持"系统管理"功能的新版本。

## 🎯 升级内容

### Goals（目标库）
- ✅ 新增字段：`Is System Managed`（复选框）- 勾选后加入系统管理
- ✅ 新增字段：`Daily Target Hours`（数字）- 每日目标时长

### Activity Details（活动明细表）
- ✅ 新增字段：`Activity Type`（选择）- 活动类型
- ✅ 新增字段：`Related Goal`（关联）- 关联目标
- ✅ 新增字段：`Related Todo`（关联）- 关联待办
- ✅ 新增字段：`Related Knowledge`（关联）- 关联知识库
- ✅ 新增字段：`Todo Status After`（选择）- 记录后待办状态

## 📋 升级前准备

### 1. 获取数据库ID

在小程序中：
1. 进入"设置" → "Notion集成配置"
2. 展开"🎯 六数据库配置（推荐）"
3. 复制以下数据库ID：
   - Goals数据库ID
   - Activity Details数据库ID
   - Todos数据库ID
   - Knowledge数据库ID

### 2. 确认API Key

- 确保有Notion API Key
- 确保API Key有权限访问上述数据库

## 🚀 执行升级

### 步骤1：安装依赖

```bash
cd /Users/jay/Documents/baidu/projects/yjxs
npm install
```

### 步骤2：运行升级脚本

```bash
npm run upgrade-databases
```

或者：

```bash
node scripts/upgradeToSystemManagement.js
```

### 步骤3：按提示输入

脚本会依次提示输入：

```
请输入Notion API Key: [粘贴API Key]

请输入各数据库ID（可从小程序"Notion集成配置"页面获取）：
Goals数据库ID: [粘贴ID]
Activity Details数据库ID: [粘贴ID]
Todos数据库ID: [粘贴ID]
Knowledge数据库ID: [粘贴ID]
```

### 步骤4：确认升级

查看升级计划，输入 `yes` 确认：

```
确认执行升级？(输入 yes 确认): yes
```

### 步骤5：等待完成

升级过程约1-2分钟，会显示进度：

```
🚀 开始升级...

📚 [1/2] 升级 Goals 数据库...
  ✅ "Is System Managed" 字段已添加
  ✅ "Daily Target Hours" 字段已添加

⏱️  [2/2] 升级 Activity Details 数据库...
  ✅ "Activity Type" 字段已添加
  ✅ "Related Goal" 关联已添加
  ✅ "Related Todo" 关联已添加
  ✅ "Related Knowledge" 关联已添加
  ✅ "Todo Status After" 字段已添加

🎉 数据库升级完成！
```

## ✅ 升级后配置

### 1. 配置系统管理目标

在小程序中：
1. 进入"目标·待办"页面
2. 编辑需要加入系统管理的目标
3. 勾选"☑️ 加入系统管理"
4. 设置"每日目标时长"（如：2.0小时）
5. 保存

**示例**：
```
目标名称：N2日语能力考试
目标时长：500小时
☑️ 加入系统管理
每日目标时长：2.0小时
```

### 2. 使用新版足迹页面

升级完成后，足迹页面会：
- 自动加载勾选了"系统管理"的目标
- 支持按活动类型记录：系统目标/每日事项/流水账
- 自动更新目标进度
- 支持关联知识库

## ⚠️ 注意事项

### 数据安全
- ✅ 升级不会删除任何现有数据
- ✅ 现有记录的新字段将为空值
- ✅ 旧功能继续可用，不受影响
- ⚠️ 建议先在测试数据库上执行升级

### 常见问题

**Q1: 升级失败怎么办？**
- 检查数据库ID是否正确
- 检查API Key是否有权限
- 检查网络连接是否正常
- 查看错误信息，根据提示修正

**Q2: 升级后能回退吗？**
- 不支持自动回退
- 但可以手动删除新增字段（在Notion中操作）
- 现有数据不受影响

**Q3: Main Records数据库怎么办？**
- 保留，不需要删除
- 新功能不再使用Main Records
- 历史数据仍然保留

**Q4: 必须配置系统管理吗？**
- 不是必须的
- 可以继续使用旧功能
- 需要系统管理功能时再配置

## 📊 升级效果

### 升级前
- 手动记录活动
- 手动更新目标进度
- 缺少活动分类

### 升级后
- ✅ 自动加载系统管理目标
- ✅ 记录活动自动更新目标进度
- ✅ 活动分类清晰（系统目标/每日事项/流水账）
- ✅ 支持关联知识库
- ✅ 统一的表格展示

## 🆘 获取帮助

如果升级过程中遇到问题：
1. 查看控制台错误信息
2. 检查数据库配置
3. 确认API Key权限
4. 联系开发者

---

*升级指南创建日期：2025年11月16日*
