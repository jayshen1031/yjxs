# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 🚨 核心工作铁律（最高优先级）

### ⚠️ 绝对禁止事项
1. **禁止使用模拟数据** - 任何情况下都不允许使用模拟、假数据或占位符数据
2. **禁止擅自修改用户方案** - 不得随意更改用户提出的技术方案和架构决策
3. **必须征求用户意见** - 任何重大变更都必须先向用户说明并征求同意

### ✅ 正确做法
- 使用真实的云数据库、API和服务
- 严格按照用户指定的技术路线执行
- 遇到问题时提供选项供用户选择，而不是擅自决定
- 保持对用户决策的尊重和执行

**重要提醒：每次加载项目记忆时都要严格遵守这些铁律**

## 项目概述
**项目名称**：语寄心声微信小程序  
**开发时间**：2025年1月  
**项目路径**：`/Users/jay/Documents/baidu/projects/yjxs`

## 核心需求
用户想要开发一个微信小程序，具备以下功能：
1. 记录日常备忘录
2. 支持语音输入和文本输入
3. 首页显示自定义箴言（从箴言库抽取）
4. 支持定时记录提醒（1小时或几小时一次）
5. 具备时间线功能
6. 具备历史记录功能
7. **✨ 新增需求：每天的最后一条记录应该是重点：规划第二天的事项**

## 技术实现

### 项目架构
- **框架**：微信小程序原生开发
- **页面结构**：5个主要页面（home, memo, timeline, history, settings）
- **数据存储**：本地存储（localStorage）
- **音频处理**：微信小程序RecorderManager + InnerAudioContext

### 核心功能实现

#### 1. 箴言系统
- 在`app.js`中内置15条正能量箴言
- 每日随机选择一条显示
- 使用日期作为种子确保同一天显示相同箴言

#### 2. 记录功能
- 文本记录：textarea组件，支持500字符
- 语音记录：长按录制，最长60秒
- 标签系统：预设标签 + 自定义标签
- 快速模板：预设常用记录模板

#### 3. 语音处理
- 录音权限检查和申请
- 录音状态实时显示
- 语音转文字（模拟实现，可接入真实API）
- 录音播放控制

#### 4. 数据管理
- 全局数据存储在`app.js`的globalData中
- 本地持久化使用wx.setStorageSync/getStorageSync
- 数据结构：
```javascript
{
  id: string,           // 唯一标识
  content: string,      // 记录内容
  type: 'text'|'voice', // 记录类型
  tags: string[],       // 标签数组
  timestamp: number,    // 时间戳
  audioPath: string     // 音频文件路径（语音记录）
}
```

#### 5. 时间线展示
- 按时间倒序排列
- 支持搜索和筛选
- 时间线节点设计
- 语音播放控制

#### 6. 历史记录
- 按日期分组
- 高级筛选功能
- 统计数据展示
- 分页加载

#### 7. 提醒系统
- 可配置提醒间隔（30分钟-8小时）
- 使用setInterval实现
- 模态框提醒
- **智能规划提醒**：晚上21点后提醒规划明日事项

#### 8. 每日规划功能 ⭐
- **记录模式选择**：日常记录 vs 明日规划
- **专用规划模板**：包含"明天要完成..."等规划导向模板
- **首页重点显示**：突出显示昨日规划作为今日重点
- **视觉差异化**：规划记录采用橙色主题
- **数据结构增强**：添加`isPlanning`和`recordMode`字段
- **时间线区分**：规划记录在时间线中特殊显示

## 界面设计特色

### 设计风格
- 现代化卡片设计
- 渐变色彩方案
- 圆角和阴影
- 流畅动画效果

### 色彩搭配
- **主色：靛蓝渐变** (#6366f1 → #8b5cf6) - 用于日常记录
- **规划色：橙色渐变** (#f59e0b → #d97706) - 用于明日规划
- **辅色：暖橙色** (#ef4444 → #f97316) - 用于语音记录
- **背景：浅灰蓝** (#f8fafc)
- **文字：深灰色** (#1f2937)

### 交互体验
- 防抖搜索
- 状态反馈
- 优雅的空状态
- 响应式布局

## 文件结构
```
memo-miniprogram/
├── app.js              # 应用入口，全局数据管理
├── app.json            # 应用配置，页面注册
├── app.wxss            # 全局样式
├── pages/
│   ├── home/           # 首页：箴言、统计、快速操作
│   ├── memo/           # 记录页：文字/语音输入
│   ├── timeline/       # 时间线：记录列表展示
│   └── history/        # 历史：高级筛选和管理
├── utils/
│   └── util.js         # 工具函数库
├── sitemap.json        # 站点地图
├── project.config.json # 项目配置
└── README.md           # 项目文档
```

## 开发要点

### 已解决的技术难点
1. **语音录制权限处理**：权限检查、申请、错误处理
2. **音频播放状态管理**：多个音频互斥播放
3. **时间格式化**：相对时间、绝对时间转换
4. **数据筛选和搜索**：多条件组合筛选
5. **响应式设计**：适配不同屏幕尺寸

### 性能优化
1. 图片资源懒加载（预留）
2. 列表虚拟滚动（预留）
3. 防抖节流优化
4. 本地存储容量管理

## 扩展建议

### 近期可增加功能
1. 真实语音识别API集成
2. 图片记录功能
3. 数据导出功能
4. 主题切换

### 长期发展方向
1. 云端数据同步
2. 多设备同步
3. AI智能分析
4. 社交分享功能

## Notion四数据库架构设计 ⭐ (2025-01-08)

### 架构概述
从原有的双数据库（主记录表 + 活动明细表）扩展为**四数据库架构**：
1. **主记录表（Main Records）** - 每日记录汇总
2. **活动明细表（Activity Details）** - 每个活动的时间投入
3. **目标库（Goals）** - 人生目标、阶段目标管理 ⭐ 新增
4. **待办事项库（Todos）** - 目标导向和临时待办管理 ⭐ 新增

### 1. 目标库（Goals Database）

#### 核心字段
- **Name**（标题）：目标名称
- **Description**（富文本）：目标详细描述
- **Category**（选择）：目标层级
  - 人生目标（Life Goal）
  - 年度目标（Yearly Goal）
  - 季度目标（Quarterly Goal）
  - 月度目标（Monthly Goal）
  - 周目标（Weekly Goal）
- **Type**（选择）：目标类型（事业/健康/财务/学习/人际/兴趣/家庭）
- **Start Date**（日期）、**Target Date**（日期）、**Actual Completion Date**（日期）
- **Status**（选择）：未开始/进行中/已完成/已暂停/已取消
- **Progress**（数字0-100）：完成百分比
- **Is Quantifiable**（复选框）、**Target Value**（数字）、**Current Value**（数字）、**Unit**（文本）
- **Priority**（选择）：高/中/低
- **Importance**（选择）：核心/重要/辅助

#### 关联和统计
- **Sub Goals**（关联）：子目标（自关联实现层级）
- **Parent Goal**（关联）：父目标
- **Related Todos**（关联）：关联的待办事项
- **Related Activities**（关联）：关联的活动明细
- **Total Time Invested**（汇总）：总投入时间
- **Completed Todos**（汇总）、**Total Todos**（汇总）
- **Todo Completion Rate**（公式）：待办完成率
- **User ID**（文本）、**Tags**（多选）、**Notes**（富文本）

### 2. 待办事项库（Todos Database）

#### 核心字段
- **Title**（标题）：待办事项名称
- **Description**（富文本）：详细描述
- **Todo Type**（选择）：⭐ 核心字段
  - 目标导向（Goal-oriented）- 与长期目标相关
  - 临时待办（Ad-hoc）- 日常琐事、临时任务
  - 习惯养成（Habit）- 重复性习惯培养
  - 紧急处理（Urgent）- 突发紧急事项
- **Category**（选择）：工作/学习/生活/健康/社交/杂事
- **Due Date**（日期）、**Planned Date**（日期）、**Start Time**（文本）
- **Estimated Duration**（数字）、**Actual Duration**（汇总）
- **Priority**（选择）：紧急重要/重要不紧急/紧急不重要/不紧急不重要
- **Energy Level**（选择）：高/中/低精力
- **Status**（选择）：待办/进行中/已完成/已取消/延期
- **Is Completed**（复选框）、**Completion Progress**（数字0-100）

#### 关联关系
- **Related Goal**（关联）：⚠️ 可选，只有目标导向类型建议关联
- **Related Activities**（关联）、**Related Main Records**（关联）
- **Blocking Todos**（关联）、**Blocked By**（关联）
- **Recurrence**（选择）：无/每日/每周/每月/自定义
- **Reminder**（复选框）、**Reminder Time**（日期）
- **User ID**（文本）、**Tags**（多选）、**Difficulty**（选择）

### 3. 活动明细表（现有 + 新增字段）

#### 新增字段 ⭐
- **Related Goal**（关联）：关联的目标
- **Related Todo**（关联）：关联的待办事项
- **Contribution Type**（选择）：贡献类型
  - 完成待办（Complete Todo）
  - 推进目标（Advance Goal）
  - 学习提升（Learning）
  - 休息恢复（Rest）

### 数据库关联关系图
```
Goals (目标库) ─┬─ 一对多 ──> Todos (待办库)
               └─ 一对多 ──> Activities (活动明细)
                                  ↑
                                  │ 一对多
                           Main Records (主记录)
```

### 使用场景

#### 场景1：长期目标追踪
- 创建目标："2025年读完24本书"
- 创建待办："读完《原则》"（关联目标）
- 记录活动："阅读《原则》30分钟"（关联待办和目标）
- 系统自动统计：总投入时间、待办完成率

#### 场景2：临时待办
- 创建待办："去超市买菜"（Todo Type: Ad-hoc，不关联目标）
- 记录活动："购物 20分钟"（可选关联待办）

#### 场景3：习惯养成
- 创建待办："每天做20个俯卧撑"（Todo Type: Habit，Recurrence: Daily）
- 可选关联长期健身目标
- 记录活动自动追踪习惯完成情况

## 维护要点
1. 定期清理本地存储
2. 音频文件管理
3. 权限状态检查
4. 性能监控

## 问题记录

### 微信小程序云环境配置
- 问题可能是微信小程序会优先使用project.config.json中配置的默认云环境，而不是代码中指定的环境。
- 在project.config.json中需要正确配置cloudEnvId和cloudbaseRoot

### 云环境和AppID匹配问题
- 当前项目遇到的云环境和AppID不匹配问题处理经验：
  - 检查当前项目的实际AppID（在project.config.json或微信开发者工具中）
  - 如果AppID不一致，需要修改project.config.json中的appid
  - 或者请求将当前项目的AppID添加到云环境共享授权中
  - 确保使用有云环境授权的正确AppID重新编译测试

---
*开发完成日期：2025年1月*