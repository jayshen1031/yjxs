# 📚 语寄心声 - 八数据库自动创建指南

## 概述

语寄心声小程序支持一键自动创建完整的Notion八数据库架构，新用户注册后可以快速开始使用。

## 八数据库架构

### 1. 🎯 目标库（Goals）
- 管理人生目标、年度目标、阶段目标
- 支持目标分类、进度跟踪、时间规划
- 自关联支持：父目标 ↔ 子目标

### 2. ✅ 待办库（Todos）
- 目标导向型待办和临时待办管理
- 四象限优先级管理
- 关联目标库，支持目标分解
- 自关联支持：阻塞关系、前置依赖

### 3. 📝 主记录表（Main Records）
- 每日记录汇总
- 时间段分类（早晨/上午/下午/晚上）
- 记录类型：日常记录、明日规划
- 关联待办库

### 4. ⏱️ 活动明细表（Activity Details）
- 每个活动的时间投入记录
- 活动类型分类（工作/学习/运动/休息等）
- 价值评估（有价值/中性/低效）
- 三向关联：目标库、待办库、主记录表

### 5. 📊 每日状态库（Daily Status）
- 健康和生活习惯追踪
- 心情、能量、压力水平记录
- 睡眠、运动、饮食、冥想等数据
- 独立数据库，不关联其他库

### 6. 😊 开心库（Happy Things）
- 开心事项管理
- 分类：运动、美食、社交、娱乐、学习、创作、自然、放松
- 能量等级：低、中、高
- 系统默认 + 用户自定义
- 独立数据库，不关联其他库

### 7. 💬 箴言库（Quotes）
- 每日箴言、励志语录、人生格言管理
- 9个分类：励志、人生、成长、时间、坚持、记录、感悟、习惯、梦想
- 6种标签：正能量、深度思考、轻松、哲理、实用、情感
- 展示统计：记录展示次数和日期
- 系统默认15条箴言
- 独立数据库，不关联其他库

### 8. 📚 知识库（Knowledge） ⭐ 新增
- 知识管理和学习笔记库
- 分类：技术、业务、个人成长、读书笔记、灵感、其他
- 标签支持：多标签分类
- 内容格式：支持Markdown、富文本、摘要预览
- 学习阶段：未开始、学习中、已掌握、需复习
- 独立数据库，不关联其他库

## 自动创建功能

### 方式1：新用户注册时自动创建

**流程**：
1. 用户完成注册
2. 输入Notion API Key
3. 系统自动创建八个数据库
4. 自动保存数据库ID到用户配置
5. 完成！开始使用

**代码位置**：
- 注册页面调用：`pages/login/login.js`
- 核心服务：`utils/notionQuadDatabaseCreator.js`

### 方式2：配置页面手动触发

**流程**：
1. 进入"Notion集成配置"页面
2. 输入API Key
3. 点击"一键创建数据库"按钮
4. 系统创建八个数据库
5. 自动填充数据库ID

**触发条件**：
- 用户已配置Notion API Key
- 数据库ID尚未配置（或选择重新创建）

### 方式3：代码直接调用

**示例代码**：
```javascript
const { createQuadDatabases } = require('./utils/notionQuadDatabaseCreator.js')

// 调用自动创建
const result = await createQuadDatabases(apiKey, parentPageId)

if (result.success) {
  console.log('✅ 创建成功！')
  console.log('目标库ID:', result.databases.goals)
  console.log('待办库ID:', result.databases.todos)
  console.log('主记录表ID:', result.databases.mainRecords)
  console.log('活动明细表ID:', result.databases.activityDetails)
  console.log('每日状态库ID:', result.databases.dailyStatus)
  console.log('开心库ID:', result.databases.happyThings)
  console.log('箴言库ID:', result.databases.quotes)
  console.log('知识库ID:', result.databases.knowledge)
} else {
  console.error('❌ 创建失败:', result.error)
}
```

## 创建过程详解

### 执行步骤

```
开始创建八数据库架构
    ↓
[1/8] 创建目标库
    ↓
[2/8] 创建待办库（关联目标库）
    ↓
[3/8] 创建主记录表（关联待办库）
    ↓
[4/8] 创建活动明细表（关联目标库、待办库、主记录表）
    ↓
[5/8] 创建每日状态库（独立）
    ↓
[6/8] 创建开心库（独立）
    ↓
[7/8] 创建箴言库（独立）
    ↓
[8/8] 创建知识库（独立） ⭐ 新增
    ↓
[9/10] 更新目标库自关联（Parent/Sub Goals）
    ↓
[10/10] 更新待办库自关联（Blocking/Blocked By）
    ↓
✅ 完成！
```

### 关联关系自动配置

#### 目标库（Goals）
- **Sub Goals** ← 自关联 → **Parent Goal**
- **Related Todos** ← 关联待办库

#### 待办库（Todos）
- **Related Goal** ← 关联目标库
- **Blocking Todos** ← 自关联 → **Blocked By**

#### 主记录表（Main Records）
- **Related Todos** ← 关联待办库

#### 活动明细表（Activity Details）
- **Related Goal** ← 关联目标库
- **Related Todo** ← 关联待办库
- **Related Main Record** ← 关联主记录表

## 返回数据结构

```javascript
{
  success: true,
  databases: {
    goals: '数据库ID',
    todos: '数据库ID',
    mainRecords: '数据库ID',
    activityDetails: '数据库ID',
    dailyStatus: '数据库ID',
    happyThings: '数据库ID',    // 已支持
    quotes: '数据库ID'          // ⭐ 新增
  }
}
```

## 初始化数据

### 开心库初始化
创建完成后，建议调用：
```javascript
const happyService = require('./utils/happyThingsService.js')
await happyService.initializeHappyThingsDatabase()
```
自动导入40+条系统默认开心事项。

### 箴言库初始化 ⭐ 新增
创建完成后，建议调用：
```javascript
const quoteService = require('./utils/quoteService.js')
await quoteService.initializeQuotesDatabase()
```
自动导入15条系统默认箴言。

## 配置保存

创建完成后，系统会自动：
1. 保存所有数据库ID到用户配置
2. 更新本地缓存
3. 同步到云数据库
4. 启用Notion集成功能

**配置数据结构**：
```javascript
notionConfig: {
  apiKey: 'secret_xxx',
  enabled: true,
  databases: {
    goals: 'db_id_1',
    todos: 'db_id_2',
    mainRecords: 'db_id_3',
    activityDetails: 'db_id_4',
    dailyStatus: 'db_id_5',
    happyThings: 'db_id_6',
    quotes: 'db_id_7'        // ⭐ 新增
  }
}
```

## 使用建议

### 新用户推荐流程

1. **注册登录**
   - 使用邮箱注册
   - 完成用户信息配置

2. **配置Notion**
   - 在Notion中创建Integration
   - 获取API Key
   - 在小程序中输入API Key

3. **自动创建数据库**
   - 点击"一键创建数据库"
   - 等待创建完成（约30秒）
   - 查看Notion确认数据库已创建

4. **初始化数据**（可选）
   - 导入系统默认箴言（15条）
   - 导入系统默认开心事项（40+条）

5. **开始使用**
   - 查看每日箴言
   - 创建第一个目标
   - 添加第一个待办
   - 记录第一次时间投入

### 已有用户迁移

如果您已经手动创建了部分数据库：

**方案1：保留手动创建的数据库**
- 在配置页面手动输入已有数据库的ID
- 只创建缺失的数据库

**方案2：重新自动创建**
- 备份现有数据
- 使用自动创建功能创建新库
- 手动迁移数据
- 删除旧数据库

## 常见问题

### Q1: 创建失败怎么办？
**A**: 检查以下几点：
- API Key是否正确
- Notion Integration是否有权限
- 网络连接是否正常
- 查看错误日志定位问题

### Q2: 可以重复创建吗？
**A**: 可以，但会创建新的数据库，不会覆盖现有数据库。建议先删除旧库再创建。

### Q3: 创建后可以修改数据库结构吗？
**A**: 可以在Notion中手动添加字段，但不建议删除系统必需的字段。

### Q4: 可以选择性创建某几个数据库吗？
**A**: 当前版本暂不支持，自动创建会创建全部七个数据库。如需部分创建，请手动配置。

### Q5: 箴言库和开心库是必须的吗？
**A**: 不是必须的。如果不配置这两个库：
- 箴言功能会使用系统默认的15条箴言
- 开心推荐功能会使用系统默认的40+条开心事项
- 但不会同步到Notion，也无法自定义

## 技术细节

### 核心文件

1. **utils/notionQuadDatabaseCreator.js**
   - 七数据库创建器主类
   - 包含所有创建方法
   - 处理关联关系配置

2. **utils/notionDatabaseSetup.js**
   - 数据库Schema定义
   - 字段配置
   - 选项配置

3. **utils/notionApiService.js**
   - Notion API调用封装
   - 错误处理
   - 重试机制

### 创建方法

- `createGoalsDatabase()` - 创建目标库
- `createTodosDatabase(goalsDbId)` - 创建待办库
- `createMainRecordsDatabase(todosDbId)` - 创建主记录表
- `createActivityDetailsDatabase(goalsDbId, todosDbId, mainDbId)` - 创建活动明细表
- `createDailyStatusDatabase()` - 创建每日状态库
- `createHappyThingsDatabase()` - 创建开心库
- `createQuotesDatabase()` - 创建箴言库 ⭐ 新增
- `updateGoalsSelfRelation(goalsDbId)` - 更新目标库自关联
- `updateTodosSelfRelation(todosDbId)` - 更新待办库自关联

### 调用示例

```javascript
const creator = new NotionQuadDatabaseCreator(apiKey, parentPageId)

// 方式1：创建全部
const result = await creator.createAll()

// 方式2：单独创建某个库
const quotesDb = await creator.createQuotesDatabase()
const happyDb = await creator.createHappyThingsDatabase()
```

## 版本历史

- **v1.0** (2025-01-09) - 初始版本，支持四数据库（Goals, Todos, Main Records, Activity Details）
- **v1.1** (2025-01-10) - 新增每日状态库（Daily Status）
- **v1.2** (2025-10-12) - 新增开心库（Happy Things）
- **v1.3** (2025-10-19) - 新增箴言库（Quotes），升级为七数据库架构
- **v1.4** (2025-10-26) - 新增知识库（Knowledge），升级为八数据库架构 ⭐

## 相关文档

- [箴言库设计文档](./箴言库设计文档.md)
- [Notion四数据库架构说明](./NOTION_QUAD_DATABASE_SETUP.md)
- [开心库功能说明](./CLAUDE.md)

---

**开发者**: Claude Code
**创建日期**: 2025-10-19
**版本**: v1.3
