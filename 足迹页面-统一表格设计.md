# 足迹页面 - 统一活动明细表格设计

## 📱 页面整体设计

```
┌─ 📅 2025年11月16日 ───────────────────────────────┐
│ [◀ 前一天] [选择日期] [后一天 ▶] [今天]           │
│                                                    │
│ 📊 今日统计                                         │
│ ┌────────────────────────────────────────────────┐ │
│ │ 总时长: 5.5h │ 目标投入: 3.5h │ 事项投入: 1.5h│ │
│ │ 流水账: 0.5h │ 活动数: 6      │              │ │
│ └────────────────────────────────────────────────┘ │
│                                                    │
│ ⏱️ 今日活动明细（按时间排序）                       │
│ ┌──┬──┬──────────────┬────────┬───┬───┐          │
│ │始│终│ 活动         │ 关联   │时长│操作│          │
│ ├──┼──┼──────────────┼────────┼───┼───┤          │
│ │07│07│ 晨跑         │💪减重   │30 │✏️🗑│          │
│ │00│30│              │        │min│   │          │
│ ├──┼──┼──────────────┼────────┼───┼───┤          │
│ │09│10│ 写项目报告   │✅报告   │90 │✏️🗑│          │
│ │00│30│              │📚工作   │min│   │          │
│ ├──┼──┼──────────────┼────────┼───┼───┤          │
│ │10│11│ 喝咖啡       │        │30 │✏️🗑│          │
│ │30│00│              │        │min│   │          │
│ ├──┼──┼──────────────┼────────┼───┼───┤          │
│ │14│16│ 学习日语语法 │🎯N2日语 │120│✏️🗑│          │
│ │00│00│              │📚日语   │min│   │          │
│ ├──┼──┼──────────────┼────────┼───┼───┤          │
│ │16│17│ 回复邮件     │✅邮件   │60 │✏️🗑│          │
│ │00│00│              │        │min│   │          │
│ └──┴──┴──────────────┴────────┴───┴───┘          │
│                                                    │
│ [+ 添加活动]                                        │
│                                                    │
│ 💡 提示：                                           │
│ • 时间只能选择整点或半点（如：14:00、14:30）        │
│ • 活动自动按时间排序                                │
│ • 关联目标/待办会自动更新进度                       │
└────────────────────────────────────────────────────┘
```

---

## 🎨 添加活动弹窗

```
┌─ 添加活动 ────────────────────────────┐
│                                        │
│ 活动类型：                              │
│ ● 🎯 系统目标   ○ ✅ 每日事项   ○ 📝 流水账 │
│                                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │
│                                        │
│ 【如果选择"系统目标"】                   │
│ 关联目标：                              │
│ [选择目标 ▼]                            │
│   📚 N2日语 (日目标2.0h，今日0h)        │
│   💪 减重10斤 (日目标1.0h，今日0.5h)    │
│   🎸 学吉他 (日目标1.0h，今日0h)        │
│                                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │
│                                        │
│ 【如果选择"每日事项"】                   │
│ 关联待办：                              │
│ [选择待办 ▼]                            │
│   📄 完成项目报告 (进行中，今日90min)    │
│   📧 回复客户邮件 (进行中，今日0min)     │
│   🛒 买菜 (暂停执行)                    │
│                                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │
│                                        │
│ 【如果选择"流水账"】                     │
│ （不需要关联）                          │
│                                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │
│                                        │
│ 活动名称：                              │
│ [学习日语语法第三章]                    │
│                                        │
│ 时间段：                                │
│ 开始：[14] : [00 ▼]                    │
│              └─ 00 / 30                │
│                                        │
│ 结束：[16] : [00 ▼]                    │
│              └─ 00 / 30                │
│                                        │
│ 时长：2.0小时（自动计算）                │
│                                        │
│ 关联知识库（可选）：                     │
│ [选择知识库 ▼]                          │
│   📚 日语学习笔记                        │
│   📚 工作笔记                            │
│   📚 读书笔记                            │
│                                        │
│ 备注（可选）：                           │
│ [今天学了ます形的变形规则...]            │
│                                        │
│ [保存] [取消]                           │
└────────────────────────────────────────┘
```

---

## 🗄️ Activity Details 数据库字段设计

### 完整字段列表

| 字段名 | 类型 | 是否必填 | 说明 |
|--------|------|----------|------|
| **Activity Name** | Title | ✅ 必填 | 活动名称 |
| **Date** | Date | ✅ 必填 | 日期 |
| **Start Time** | Text | ✅ 必填 | 开始时间（格式：HH:MM） |
| **End Time** | Text | ✅ 必填 | 结束时间（格式：HH:MM） |
| **Duration** | Number | ✅ 必填 | 时长（分钟，自动计算） |
| **Activity Type** | Select | ✅ 必填 | 活动类型 |
| Related Goal | Relation | ⭕ 可选 | 关联目标（系统目标类型必填） |
| Related Todo | Relation | ⭕ 可选 | 关联待办（每日事项类型必填） |
| Related Knowledge | Relation | ⭕ 可选 | 关联知识库 |
| Notes | Rich Text | ⭕ 可选 | 备注说明 |
| User ID | Text | ✅ 必填 | 用户标识 |

### Activity Type 选项

```
系统目标 (System Goal)    - 关联长期目标，需持续投入
每日事项 (Daily Task)     - 关联临时待办，完成即消失
流水账 (Journal)          - 不关联任何目标/待办
```

### 时间格式约束

**Start Time / End Time**：
- 格式：`HH:MM`（24小时制）
- 小时：`00-23`
- 分钟：只能是 `00` 或 `30`

**有效示例**：
- ✅ `07:00`
- ✅ `14:30`
- ✅ `23:00`

**无效示例**：
- ❌ `7:00`（小时需要两位数）
- ❌ `14:15`（分钟只能00或30）
- ❌ `14:45`（分钟只能00或30）

### Duration 计算

```javascript
// 自动计算时长（分钟）
function calculateDuration(startTime, endTime) {
  const [startHour, startMin] = startTime.split(':').map(Number)
  const [endHour, endMin] = endTime.split(':').map(Number)

  const startMinutes = startHour * 60 + startMin
  const endMinutes = endHour * 60 + endMin

  return endMinutes - startMinutes
}

// 示例
calculateDuration('14:00', '16:00') // 120分钟
calculateDuration('14:30', '15:00') // 30分钟
```

---

## 🗄️ Goals 数据库字段（新增系统管理）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| Goal Name | Title | 目标名称 |
| Target Hours | Number | 目标总时长 |
| Current Hours | Number | 当前累计时长 |
| Progress | Formula | 进度 = Current/Target*100% |
| **Is System Managed** | Checkbox | ⭐ 是否加入系统管理 |
| **Daily Target Hours** | Number | ⭐ 每日目标时长 |

**Is System Managed 勾选后**：
- 在"添加活动"时可选择该目标
- 每次记录活动会自动累加 Current Hours
- 可设置每日目标，方便检查是否达标

---

## 🗄️ Todos 数据库字段（保持现有）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| Title | Title | 待办名称 |
| Status | Select | 状态（进行中/暂停执行/已完成） |
| Priority | Select | 优先级 |
| Due Date | Date | 截止日期 |

**显示逻辑**：
- 在"添加活动"时，只显示 `Status ≠ '已完成'` 的待办
- 完成后的待办不再出现在选择列表中

---

## 📊 数据统计逻辑

### 今日统计

```javascript
// 查询今日所有活动
const todayActivities = ActivityDetails.filter(a => a.Date === today)

// 总时长
const totalMinutes = sum(todayActivities.map(a => a.Duration))
const totalHours = totalMinutes / 60

// 按类型统计
const goalMinutes = sum(
  todayActivities
    .filter(a => a.Activity_Type === '系统目标')
    .map(a => a.Duration)
)

const taskMinutes = sum(
  todayActivities
    .filter(a => a.Activity_Type === '每日事项')
    .map(a => a.Duration)
)

const journalMinutes = sum(
  todayActivities
    .filter(a => a.Activity_Type === '流水账')
    .map(a => a.Duration)
)

// 活动数
const activityCount = todayActivities.length
```

### 目标进度更新

```javascript
// 当保存"系统目标"类型的活动时
function saveGoalActivity(activity) {
  // 1. 创建 Activity Details 记录
  await createActivityDetail(activity)

  // 2. 更新关联目标的累计时长
  const goal = await getGoal(activity.Related_Goal)
  goal.Current_Hours += activity.Duration / 60
  await updateGoal(goal)

  // 3. 刷新页面显示
  refreshPage()
}
```

---

## 🎯 表格显示逻辑

### 排序规则

```javascript
// 按开始时间升序排列（最早的在上面）
activities.sort((a, b) => {
  const timeA = a.Start_Time.replace(':', '')
  const timeB = b.Start_Time.replace(':', '')
  return parseInt(timeA) - parseInt(timeB)
})
```

### 关联显示

```
关联列显示规则：
- 如果关联目标：显示 🎯目标名称
- 如果关联待办：显示 ✅待办名称
- 如果关联知识库：显示 📚知识库名称
- 可以同时显示多个关联（换行显示）

示例：
┌────────┐
│🎯N2日语│
│📚日语   │
└────────┘
```

### 颜色标识

```css
/* 不同活动类型用不同背景色 */
.activity-row.system-goal {
  background: #eff6ff; /* 浅蓝色 - 系统目标 */
}

.activity-row.daily-task {
  background: #fef3c7; /* 浅黄色 - 每日事项 */
}

.activity-row.journal {
  background: #f3f4f6; /* 浅灰色 - 流水账 */
}
```

---

## 🔄 完整工作流程

### 1. 添加系统目标活动

```
用户点击 [+ 添加活动]
    ↓
选择类型：🎯 系统目标
    ↓
选择关联目标：📚 N2日语
    ↓
填写活动名称：学习日语语法第三章
    ↓
选择时间段：14:00 - 16:00
    ↓
（可选）关联知识库：📚 日语学习笔记
    ↓
点击保存
    ↓
① 创建 Activity Details 记录
   {
     Activity Name: "学习日语语法第三章",
     Date: "2025-11-16",
     Start Time: "14:00",
     End Time: "16:00",
     Duration: 120,
     Activity Type: "系统目标",
     Related Goal: "N2日语",
     Related Knowledge: "日语学习笔记"
   }
    ↓
② 更新 Goal
   Current Hours: 120 → 122
   Progress: 24% → 24.4%
    ↓
③ 刷新页面
   - 统计卡片：目标投入 +2.0h
   - 表格：新增一行，按时间排序插入
```

### 2. 添加每日事项活动

```
用户点击 [+ 添加活动]
    ↓
选择类型：✅ 每日事项
    ↓
选择关联待办：📄 完成项目报告
    ↓
填写活动名称：写项目报告
    ↓
选择时间段：09:00 - 10:30
    ↓
点击保存
    ↓
① 创建 Activity Details 记录
   {
     Activity Name: "写项目报告",
     Date: "2025-11-16",
     Start Time: "09:00",
     End Time: "10:30",
     Duration: 90,
     Activity Type: "每日事项",
     Related Todo: "完成项目报告"
   }
    ↓
② （可选）判断待办是否完成
   用户可以手动在待办页面更新状态
    ↓
③ 刷新页面
   - 统计卡片：事项投入 +1.5h
   - 表格：新增一行，按时间排序插入
```

### 3. 添加流水账活动

```
用户点击 [+ 添加活动]
    ↓
选择类型：📝 流水账
    ↓
填写活动名称：喝咖啡聊天
    ↓
选择时间段：10:30 - 11:00
    ↓
点击保存
    ↓
① 创建 Activity Details 记录
   {
     Activity Name: "喝咖啡聊天",
     Date: "2025-11-16",
     Start Time: "10:30",
     End Time: "11:00",
     Duration: 30,
     Activity Type: "流水账"
     // 不关联任何目标/待办/知识库
   }
    ↓
② 刷新页面
   - 统计卡片：流水账 +0.5h
   - 表格：新增一行，按时间排序插入
```

---

## ✅ 优势总结

1. **统一数据源**：
   - 所有活动都在 Activity Details 表
   - 不再有 Main Records 冗余
   - 数据结构清晰简单

2. **灵活分类**：
   - 系统目标：长期投入，自动累计进度
   - 每日事项：临时待办，完成即消失
   - 流水账：随意记录，不影响目标

3. **时间管理**：
   - 时间只能选半点或整点，减少选择复杂度
   - 按时间排序，一目了然
   - 自动计算时长

4. **知识沉淀**：
   - 每个活动都可以关联知识库
   - 方便后续回顾和学习

5. **用户体验**：
   - 统一的表格展示
   - 简单的添加流程
   - 清晰的统计反馈

---

## 📋 需要修改的文件清单

### 1. 数据库架构
- `utils/notionDatabaseSetup.js`
  - Goals 增加：Is System Managed, Daily Target Hours
  - Activity Details 更新字段定义
  - 删除 Main Records 定义

### 2. 足迹页面
- `pages/history/history.wxml`
  - 删除原有的复杂筛选和分组
  - 改为统一的活动明细表格
  - 添加新活动弹窗

- `pages/history/history.js`
  - 加载今日活动并按时间排序
  - 计算今日统计
  - 添加活动功能（三种类型）
  - 时间选择器（只能选00或30）

- `pages/history/history.wxss`
  - 表格样式
  - 不同活动类型的颜色

### 3. 目标编辑
- `pages/goals-todos/goals-todos.wxml`
  - 增加系统管理勾选框

- `pages/goals-todos/goals-todos.js`
  - 保存时包含系统管理字段

### 4. Notion API
- `utils/notionApiService.js`
  - 查询系统管理目标
  - 更新目标进度
  - 创建活动明细

### 5. 清理 Main Records
- 删除所有 Main Records 相关代码

---

*设计日期：2025年11月16日*
