# 数据库升级功能使用说明

## 已完成的工作

### 1. 在小程序设置页面添加升级按钮 ✅

**位置**：设置页面 → Notion集成 → 自动创建模式

**按钮**：⬆️ 升级到系统管理版本

### 2. 实现自动升级功能 ✅

**功能特点**：
- ✅ 自动获取当前用户的Notion配置（API Key和数据库ID）
- ✅ 一键点击完成升级
- ✅ 实时显示升级进度
- ✅ 完整的错误处理和用户提示
- ✅ 升级过程约1-2分钟

**升级内容**：

#### Goals数据库
- ✓ Is System Managed（复选框）- 标记是否加入系统管理
- ✓ Daily Target Hours（数字）- 每日目标时长

#### Activity Details数据库
- ✓ Activity Type（选择）- 活动类型（系统目标/每日事项/流水账）
- ✓ Related Goal（关联）- 关联目标库
- ✓ Related Todo（关联）- 关联待办库
- ✓ Related Knowledge（关联）- 关联知识库
- ✓ Todo Status After（选择）- 记录后待办状态（进行中/已完成）

## 使用方法

### 步骤1：打开小程序

在微信开发者工具中打开小程序

### 步骤2：进入设置页面

点击底部导航 → 设置

### 步骤3：找到升级按钮

向下滚动到"Notion集成"卡片

在"自动创建数据库"和"诊断数据库字段"按钮下方，你会看到：

```
⬆️ 升级到系统管理版本
```

### 步骤4：点击升级

1. 点击按钮
2. 阅读确认对话框（显示升级内容）
3. 点击"开始升级"
4. 等待1-2分钟（会显示进度提示）
5. 看到"🎉 升级成功"提示即完成

## 升级流程

```
点击升级按钮
    ↓
显示确认对话框
    ↓
用户确认
    ↓
开始升级...
    ↓
[1/2] 升级Goals数据库
  ✓ 添加Is System Managed字段
  ✓ 添加Daily Target Hours字段
    ↓
[2/2] 升级Activity Details数据库
  ✓ 添加Activity Type字段
  ✓ 添加Related Goal关联（等待5秒创建反向关系）
  ✓ 添加Related Todo关联（等待5秒创建反向关系）
  ✓ 添加Related Knowledge关联
  ✓ 添加Todo Status After字段
    ↓
升级完成！
```

## 注意事项

### ✅ 安全性
- 升级过程**不会删除任何现有数据**
- 只是添加新字段，现有记录的新字段为空值
- 可以放心升级

### ⚠️ 前提条件
- 必须已完成八数据库配置
- 必须有有效的Notion API Key
- 必须已配置Goals、Todos、Activity Details、Knowledge四个数据库

### 📋 升级后
- 可以在目标管理页面勾选"加入系统管理"
- 可以在足迹页面使用新的活动类型分类
- 记录活动时可以关联目标、待办和知识库

## 技术实现

**修改文件**：
1. `pages/settings/settings.wxml` - 添加升级按钮
2. `pages/settings/settings.js` - 添加upgrading状态和upgradeDatabases方法
3. `app.wxss` - btn-warning样式（已存在）

**调用流程**：
```
settings.js:upgradeDatabases()
    ↓
notionApiService.callApi('databases/xxx', {...}, 'PATCH')
    ↓
Notion API (添加数据库字段)
```

## 测试建议

1. ✅ 确认按钮显示正常
2. ✅ 点击按钮显示确认对话框
3. ✅ 确认后显示"升级中..."加载状态
4. ✅ 升级过程显示进度提示
5. ✅ 升级成功显示成功对话框
6. ✅ 检查Notion数据库确认字段已添加

## 下一步

升级完成后，即可开始：
1. 更新数据库初始化脚本（让新用户自动包含这些字段）
2. 重构足迹页面（使用新的活动类型和关联功能）
3. 测试完整的系统管理工作流程

---

*功能完成时间：2025-11-16*
