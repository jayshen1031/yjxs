# 数据库字段修正记录

## 修正日期
2025-01-09

## 问题根源
自动创建脚本（`notionQuadDatabaseCreator.js`）中的字段名与实际代码使用的字段名不匹配，导致创建记录时报错：
```
Name is not a property that exists
Duration is not a property that exists
Activity Type is not a property that exists
```

## 修正详情

### 1. 主记录表（Main Records）

| 错误字段名 | 正确字段名 | 字段类型 | 位置 |
|-----------|-----------|---------|------|
| `Title` | `Name` | title | memo.js:729 |
| `Content` | `Summary` | rich_text | memo.js:730 |
| `Date` | `Record Date` | date | memo.js:731 |
| `Record Type` | `Type` | select | memo.js:732 |

**修正位置**: `notionQuadDatabaseCreator.js:373-376`

### 2. 活动明细表（Activity Details）

| 错误字段名 | 正确字段名 | 字段类型 | 位置 |
|-----------|-----------|---------|------|
| `Related Main Record` | `Record` | relation | memo.js:773 |

**修正位置**: `notionQuadDatabaseCreator.js:502`

**说明**:
- `Record` 关联主记录表
- dual_property 名称保持 `Related Activities`（在主记录表自动创建反向关联）

### 3. 待办库（Todos）

| 错误字段名 | 正确字段名 | 字段类型 | 位置 |
|-----------|-----------|---------|------|
| `Title` | `Todo Name` | title | notionApiService.js:2483 |
| `Estimated Duration` | `Estimated Minutes` | number | notionApiService.js:2490 |
| `Actual Duration` | `Actual Time` | rollup | notionApiService.js:2491 |
| _(缺失)_ | `Scope` | select | notionApiService.js:2488 |

**修正位置**:
- `notionQuadDatabaseCreator.js:257` - Todo Name
- `notionQuadDatabaseCreator.js:294` - Estimated Minutes
- `notionQuadDatabaseCreator.js:282-290` - 新增 Scope 字段
- `notionQuadDatabaseCreator.js:632` - Actual Time rollup

**Scope 字段选项**:
- `今日` (red)
- `近期` (orange)
- `未来` (gray)

### 4. 目标库（Goals）

✅ **无需修正** - 字段名已正确使用 `Goal Name`

## 关联关系说明

### 活动明细表 → 主记录表
```javascript
'Record': {
  relation: {
    database_id: mainRecordsDatabaseId,
    dual_property: {
      name: 'Related Activities'  // 在主记录表自动创建
    }
  }
}
```

### 活动明细表 → 待办库
```javascript
'Related Todo': {
  relation: {
    database_id: todosDatabaseId,
    dual_property: {
      name: 'Related Activities'  // 在待办库自动创建
    }
  }
}
```

### 待办库 Rollup 字段
```javascript
'Actual Time': {
  rollup: {
    relation_property_name: 'Related Activities',  // 从活动明细表自动创建的关联字段
    rollup_property_name: 'Duration',              // 汇总活动的Duration字段
    function: 'sum'                                // 求和
  }
}
```

## 测试建议

### 重新测试流程

1. **删除现有数据库**（如果需要）
   - 在Notion中删除手动创建的数据库

2. **使用注册流程自动创建**
   - 进入小程序注册页面
   - 按流程配置Notion API Key
   - 点击"自动创建数据库"

3. **验证字段名**
   - 检查每个数据库的字段名是否与代码一致
   - 特别关注：`Name` vs `Title`、`Record` vs `Related Main Record`

4. **功能测试**
   - 记录时间投入（包含活动明细创建）
   - 关联待办事项
   - 查看时间统计

## 兼容性处理

查询代码中已实现双字段名兼容：

```javascript
// 主记录表查询
title: props['Name']?.title?.[0]?.text?.content ||
       props['Title']?.title?.[0]?.text?.content || ''

content: props['Summary']?.rich_text?.[0]?.text?.content ||
         props['Content']?.rich_text?.[0]?.text?.content || ''

date: props['Record Date']?.date?.start ||
      props['Date']?.date?.start || ''
```

**优点**: 兼容新旧两种字段名，查询不受影响
**缺点**: 创建时必须使用正确字段名，否则会报错

## 诊断工具

已添加 `getDatabaseSchema` 方法到 `notionApiService.js`，用于检查数据库实际字段名：

```javascript
const schemaResult = await notionApiService.getDatabaseSchema(apiKey, databaseId)
console.log('数据库字段:', schemaResult.properties)
```

当创建活动明细失败时，会自动调用此方法诊断字段名不匹配问题。

## 相关文件

- `utils/notionQuadDatabaseCreator.js` - 自动创建脚本（已修正）
- `utils/notionApiService.js` - API服务（已添加诊断方法）
- `pages/memo/memo.js` - 记录页面（已添加诊断逻辑）
- `utils/notionDatabaseSetup.js` - Schema定义（参考文档）

---

*修正完成日期: 2025-01-09*
