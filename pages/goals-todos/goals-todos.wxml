<view class="container">
  <!-- é¡¶éƒ¨Tabåˆ‡æ¢ -->
  <view class="tab-header">
    <view class="tab-item {{ currentTab === 'goals' ? 'active' : '' }}" bindtap="switchTab" data-tab="goals">
      <text class="tab-title">ğŸ¯ ç›®æ ‡</text>
      <view wx:if="{{ currentTab === 'goals' }}" class="tab-indicator"></view>
    </view>
    <view class="tab-item {{ currentTab === 'todos' ? 'active' : '' }}" bindtap="switchTab" data-tab="todos">
      <text class="tab-title">ğŸ“ å¾…åŠ</text>
      <view wx:if="{{ currentTab === 'todos' }}" class="tab-indicator"></view>
    </view>
  </view>

  <!-- ç›®æ ‡è§†å›¾ -->
  <view wx:if="{{ currentTab === 'goals' }}" class="goals-view">
    <!-- ç›®æ ‡ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-section">
      <view class="stats-header">
        <text class="stats-title">ç›®æ ‡æ¦‚è§ˆ</text>
        <text class="action-btn" bindtap="addGoal">+ æ–°å»º</text>
      </view>

      <view class="stats-grid">
        <view class="stat-card">
          <text class="stat-value">{{ goalStats.total }}</text>
          <text class="stat-label">æ€»ç›®æ ‡</text>
        </view>
        <view class="stat-card active">
          <text class="stat-value">{{ goalStats.active }}</text>
          <text class="stat-label">è¿›è¡Œä¸­</text>
        </view>
        <view class="stat-card completed">
          <text class="stat-value">{{ goalStats.completed }}</text>
          <text class="stat-label">å·²å®Œæˆ</text>
        </view>
        <view class="stat-card progress">
          <text class="stat-value">{{ goalStats.averageProgress }}%</text>
          <text class="stat-label">å¹³å‡è¿›åº¦</text>
        </view>
      </view>
    </view>

    <!-- ç­›é€‰å’Œæœç´¢ -->
    <view class="filter-section">
      <view class="search-bar">
        <input
          class="search-input"
          placeholder="æœç´¢ç›®æ ‡..."
          value="{{ goalSearchKeyword }}"
          bindinput="onGoalSearchInput"
        />
      </view>

      <scroll-view class="filter-chips" scroll-x>
        <view class="chip-group">
          <text class="chip {{ selectedGoalCategory === '' ? 'active' : '' }}" bindtap="filterGoalByCategory" data-category="">å…¨éƒ¨</text>
          <text class="chip {{ selectedGoalCategory === 'äººç”Ÿç›®æ ‡' ? 'active' : '' }}" bindtap="filterGoalByCategory" data-category="äººç”Ÿç›®æ ‡">äººç”Ÿç›®æ ‡</text>
          <text class="chip {{ selectedGoalCategory === 'å¹´åº¦ç›®æ ‡' ? 'active' : '' }}" bindtap="filterGoalByCategory" data-category="å¹´åº¦ç›®æ ‡">å¹´åº¦ç›®æ ‡</text>
          <text class="chip {{ selectedGoalCategory === 'å­£åº¦ç›®æ ‡' ? 'active' : '' }}" bindtap="filterGoalByCategory" data-category="å­£åº¦ç›®æ ‡">å­£åº¦ç›®æ ‡</text>
          <text class="chip {{ selectedGoalCategory === 'æœˆåº¦ç›®æ ‡' ? 'active' : '' }}" bindtap="filterGoalByCategory" data-category="æœˆåº¦ç›®æ ‡">æœˆåº¦ç›®æ ‡</text>
          <text class="chip {{ selectedGoalCategory === 'å‘¨ç›®æ ‡' ? 'active' : '' }}" bindtap="filterGoalByCategory" data-category="å‘¨ç›®æ ‡">å‘¨ç›®æ ‡</text>
        </view>
      </scroll-view>
    </view>

    <!-- ç›®æ ‡åˆ—è¡¨ -->
    <scroll-view class="goals-list" scroll-y>
      <view wx:if="{{ filteredGoals.length === 0 }}" class="empty-state">
        <text class="empty-icon">ğŸ¯</text>
        <text class="empty-text">æš‚æ— ç›®æ ‡</text>
        <text class="empty-hint">ç‚¹å‡»å³ä¸Šè§’"æ–°å»º"åˆ›å»ºç›®æ ‡</text>
      </view>

      <view wx:for="{{ filteredGoals }}" wx:key="id" class="goal-card">
        <view class="goal-header">
          <view class="goal-title-row">
            <text class="goal-title">{{ item.title }}</text>
            <text class="goal-category">{{ item.category }}</text>
          </view>

          <view class="goal-meta">
            <text class="goal-status status-{{ item.status }}">{{ item.statusText }}</text>
            <text wx:if="{{ item.priority }}" class="goal-priority priority-{{ item.priority }}">{{ item.priorityText }}</text>
          </view>
        </view>

        <text wx:if="{{ item.description }}" class="goal-description">{{ item.description }}</text>

        <!-- è¿›åº¦æ¡ -->
        <view class="progress-section">
          <view class="progress-info">
            <text class="progress-label">è¿›åº¦</text>
            <text class="progress-value">{{ item.progress }}%</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{ item.progress }}%"></view>
          </view>
        </view>

        <!-- æ—¶é—´å’Œæ ‡ç­¾ -->
        <view class="goal-footer">
          <view class="goal-info">
            <text wx:if="{{ item.targetDate }}" class="info-item">ğŸ“… {{ item.targetDateText }}</text>
            <text wx:if="{{ item.totalTimeInvestment > 0 }}" class="info-item">â± {{ item.timeInvestmentDisplay }}</text>
          </view>
          <view wx:if="{{ item.tags && item.tags.length > 0 }}" class="goal-tags">
            <text wx:for="{{ item.tags }}" wx:key="*this" wx:for-item="tag" class="tag">{{ tag }}</text>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="goal-actions">
          <text class="action-btn-small" bindtap="editGoal" data-id="{{ item.id }}">ç¼–è¾‘</text>
          <text class="action-btn-small" bindtap="updateProgress" data-id="{{ item.id }}">æ›´æ–°è¿›åº¦</text>
          <text class="action-btn-small" bindtap="viewRelatedTodos" data-id="{{ item.id }}">æŸ¥çœ‹å¾…åŠ</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å¾…åŠè§†å›¾ -->
  <view wx:if="{{ currentTab === 'todos' }}" class="todos-view">
    <!-- å¾…åŠç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-section todos">
      <view class="stats-header">
        <text class="stats-title">å¾…åŠæ¦‚è§ˆ</text>
        <text class="action-btn" bindtap="addTodo">+ æ–°å»º</text>
      </view>

      <view class="stats-grid">
        <view class="stat-card">
          <text class="stat-value">{{ todoStats.pending }}</text>
          <text class="stat-label">å¾…åŠ</text>
        </view>
        <view class="stat-card active">
          <text class="stat-value">{{ todoStats.inProgress }}</text>
          <text class="stat-label">è¿›è¡Œä¸­</text>
        </view>
        <view class="stat-card completed">
          <text class="stat-value">{{ todoStats.completed }}</text>
          <text class="stat-label">å·²å®Œæˆ</text>
        </view>
        <view class="stat-card urgent">
          <text class="stat-value">{{ todoStats.urgent }}</text>
          <text class="stat-label">ç´§æ€¥</text>
        </view>
      </view>
    </view>

    <!-- ç­›é€‰å’Œæœç´¢ -->
    <view class="filter-section">
      <view class="search-bar">
        <input
          class="search-input"
          placeholder="æœç´¢å¾…åŠ..."
          value="{{ todoSearchKeyword }}"
          bindinput="onTodoSearchInput"
        />
      </view>

      <scroll-view class="filter-chips" scroll-x>
        <view class="chip-group">
          <text class="chip {{ selectedTodoType === '' ? 'active' : '' }}" bindtap="filterTodoByType" data-type="">å…¨éƒ¨</text>
          <text class="chip {{ selectedTodoType === 'ç›®æ ‡å¯¼å‘' ? 'active' : '' }}" bindtap="filterTodoByType" data-type="ç›®æ ‡å¯¼å‘">ç›®æ ‡å¯¼å‘</text>
          <text class="chip {{ selectedTodoType === 'ä¸´æ—¶å¾…åŠ' ? 'active' : '' }}" bindtap="filterTodoByType" data-type="ä¸´æ—¶å¾…åŠ">ä¸´æ—¶å¾…åŠ</text>
          <text class="chip {{ selectedTodoType === 'ä¹ æƒ¯å…»æˆ' ? 'active' : '' }}" bindtap="filterTodoByType" data-type="ä¹ æƒ¯å…»æˆ">ä¹ æƒ¯å…»æˆ</text>
          <text class="chip {{ selectedTodoType === 'ç´§æ€¥å¤„ç†' ? 'active' : '' }}" bindtap="filterTodoByType" data-type="ç´§æ€¥å¤„ç†">ç´§æ€¥å¤„ç†</text>
        </view>
      </scroll-view>
    </view>

    <!-- å¾…åŠåˆ—è¡¨ -->
    <scroll-view class="todos-list" scroll-y>
      <view wx:if="{{ filteredTodos.length === 0 }}" class="empty-state">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-text">æš‚æ— å¾…åŠ</text>
        <text class="empty-hint">ç‚¹å‡»å³ä¸Šè§’"æ–°å»º"åˆ›å»ºå¾…åŠ</text>
      </view>

      <view wx:for="{{ filteredTodos }}" wx:key="id" class="todo-card">
        <view class="todo-header">
          <view class="todo-check" bindtap="toggleTodoStatus" data-id="{{ item.id }}">
            <text wx:if="{{ item.status === 'å·²å®Œæˆ' }}" class="check-icon checked">âœ“</text>
            <text wx:else class="check-icon">â—‹</text>
          </view>

          <view class="todo-main">
            <view class="todo-title-row">
              <text class="todo-title {{ item.status === 'å·²å®Œæˆ' ? 'completed' : '' }}">{{ item.title }}</text>
              <text class="todo-type type-{{ item.type }}">{{ item.type }}</text>
            </view>

            <view class="todo-meta">
              <text class="priority priority-{{ item.priority }}">{{ item.priorityLabel }}</text>
              <text wx:if="{{ item.dueDate }}" class="due-date {{ item.isOverdue ? 'overdue' : '' }}">{{ item.dueDateText }}</text>
            </view>

            <view wx:if="{{ item.relatedGoalName }}" class="related-goal">
              <text class="goal-icon">ğŸ¯</text>
              <text class="goal-name">{{ item.relatedGoalName }}</text>
            </view>

            <view wx:if="{{ item.tags && item.tags.length > 0 }}" class="todo-tags">
              <text wx:for="{{ item.tags }}" wx:key="*this" wx:for-item="tag" class="tag">{{ tag }}</text>
            </view>
          </view>
        </view>

        <view class="todo-actions">
          <text class="action-btn-small" bindtap="editTodo" data-id="{{ item.id }}">ç¼–è¾‘</text>
          <text class="action-btn-small" bindtap="recordTime" data-id="{{ item.id }}">è®°å½•æ—¶é—´</text>
          <text class="action-btn-small danger" bindtap="deleteTodo" data-id="{{ item.id }}">åˆ é™¤</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘ç›®æ ‡å¼¹çª— -->
  <view wx:if="{{ showGoalModal }}" class="modal-overlay" bindtap="closeGoalModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{ editingGoal ? 'ç¼–è¾‘ç›®æ ‡' : 'æ–°å»ºç›®æ ‡' }}</text>
        <text class="close-btn" bindtap="closeGoalModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">ç›®æ ‡åç§°</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥ç›®æ ‡åç§°" value="{{ goalFormData.title }}" bindinput="onGoalTitleInput" maxlength="50" />
        </view>

        <view class="form-group">
          <text class="form-label">æè¿°</text>
          <textarea class="form-textarea" placeholder="è¯·è¾“å…¥æè¿°ï¼ˆå¯é€‰ï¼‰" value="{{ goalFormData.description }}" bindinput="onGoalDescriptionInput" maxlength="200" />
        </view>

        <view class="form-group">
          <text class="form-label">ç›®æ ‡å±‚çº§</text>
          <picker class="form-picker" mode="selector" range="{{ goalCategoryOptions }}" value="{{ goalCategoryIndex }}" bindchange="onGoalCategoryChange">
            <view class="picker-value">{{ goalCategoryOptions[goalCategoryIndex] }}</view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">ä¼˜å…ˆçº§</text>
          <picker class="form-picker" mode="selector" range="{{ priorityOptions }}" range-key="label" value="{{ goalPriorityIndex }}" bindchange="onGoalPriorityChange">
            <view class="picker-value">{{ priorityOptions[goalPriorityIndex].label }}</view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">èµ·å§‹æ—¶é—´ *</text>
          <picker class="form-picker" mode="date" value="{{ goalStartDate }}" bindchange="onGoalStartDateChange">
            <view class="picker-value">{{ goalStartDate || 'é€‰æ‹©å¼€å§‹æ—¥æœŸ' }}</view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">ç›®æ ‡æ—¥æœŸ</text>
          <picker class="form-picker" mode="date" value="{{ goalTargetDate }}" bindchange="onGoalTargetDateChange">
            <view class="picker-value">{{ goalTargetDate || 'é€‰æ‹©æˆªæ­¢æ—¥æœŸ' }}</view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">é¢„è®¡æŠ•å…¥æ—¶é—´ï¼ˆå°æ—¶ï¼‰*</text>
          <input class="form-input" type="digit" placeholder="ä¾‹å¦‚ï¼š100" value="{{ goalEstimatedHours }}" bindinput="onGoalEstimatedHoursInput" />
        </view>

        <view class="form-group">
          <text class="form-label">æ ‡ç­¾ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</text>
          <input class="form-input" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œ é‡è¦" value="{{ goalTagsInput }}" bindinput="onGoalTagsInput" />
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeGoalModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="confirmAddGoal">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘å¾…åŠå¼¹çª— -->
  <view wx:if="{{ showTodoModal }}" class="modal-overlay" bindtap="closeTodoModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{ editingTodo ? 'ç¼–è¾‘å¾…åŠ' : 'æ–°å»ºå¾…åŠ' }}</text>
        <text class="close-btn" bindtap="closeTodoModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">å¾…åŠæ ‡é¢˜</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥å¾…åŠæ ‡é¢˜" value="{{ todoFormData.title }}" bindinput="onTodoTitleInput" maxlength="50" />
        </view>

        <view class="form-group">
          <text class="form-label">æè¿°</text>
          <textarea class="form-textarea" placeholder="è¯·è¾“å…¥æè¿°ï¼ˆå¯é€‰ï¼‰" value="{{ todoFormData.description }}" bindinput="onTodoDescriptionInput" maxlength="200" />
        </view>

        <view class="form-group">
          <text class="form-label">å¾…åŠç±»å‹</text>
          <picker class="form-picker" mode="selector" range="{{ todoTypeOptions }}" range-key="label" value="{{ todoTypeIndex }}" bindchange="onTodoTypeChange">
            <view class="picker-value">{{ todoTypeOptions[todoTypeIndex].label }}</view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">ä¼˜å…ˆçº§</text>
          <picker class="form-picker" mode="selector" range="{{ todoPriorityOptions }}" range-key="label" value="{{ todoPriorityIndex }}" bindchange="onTodoPriorityChange">
            <view class="picker-value">{{ todoPriorityOptions[todoPriorityIndex].label }}</view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">æˆªæ­¢æ—¥æœŸ</text>
          <picker class="form-picker" mode="date" value="{{ todoDueDate }}" bindchange="onTodoDueDateChange">
            <view class="picker-value">{{ todoDueDate || 'é€‰æ‹©æ—¥æœŸ' }}</view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">å…³è”ç›®æ ‡ï¼ˆå¯é€‰ï¼‰</text>
          <picker class="form-picker" mode="selector" range="{{ availableGoals }}" range-key="title" value="{{ todoGoalIndex }}" bindchange="onTodoGoalChange">
            <view class="picker-value">{{ todoGoalIndex >= 0 ? availableGoals[todoGoalIndex].title : 'é€‰æ‹©ç›®æ ‡' }}</view>
          </picker>
        </view>

        <view class="form-group">
          <text class="form-label">é¢„è®¡æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</text>
          <input class="form-input" type="number" placeholder="é¢„è®¡éœ€è¦å¤šå°‘åˆ†é’Ÿ" value="{{ todoFormData.estimatedMinutes }}" bindinput="onTodoEstimatedMinutesInput" />
        </view>

        <view class="form-group">
          <text class="form-label">æ ‡ç­¾ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</text>
          <input class="form-input" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œ é‡è¦" value="{{ todoTagsInput }}" bindinput="onTodoTagsInput" />
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeTodoModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="confirmAddTodo">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- æ›´æ–°è¿›åº¦å¼¹çª— -->
  <view wx:if="{{ showProgressModal }}" class="modal-overlay" bindtap="closeProgressModal">
    <view class="modal-content small" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ›´æ–°è¿›åº¦</text>
        <text class="close-btn" bindtap="closeProgressModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">å½“å‰è¿›åº¦ï¼š{{ progressValue }}%</text>
          <slider class="progress-slider" min="0" max="100" value="{{ progressValue }}" bindchange="onProgressChange" show-value />
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeProgressModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="confirmUpdateProgress">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- è®°å½•æ—¶é—´å¼¹çª— -->
  <view wx:if="{{ showTimeModal }}" class="modal-overlay" bindtap="closeTimeModal">
    <view class="modal-content small" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">è®°å½•å®é™…è€—æ—¶</text>
        <text class="close-btn" bindtap="closeTimeModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">å®é™…è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰</text>
          <input class="form-input" type="number" placeholder="è¯·è¾“å…¥å®é™…è€—æ—¶" value="{{ actualMinutes }}" bindinput="onActualMinutesInput" />
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="closeTimeModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="confirmRecordTime">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>
