<!--pages/login/login.wxml-->
<view class="container">
  <!-- 头部Logo区域 -->
  <view class="header">
    <view class="logo">
      <text class="logo-icon">📝</text>
      <text class="logo-text">语寄心声</text>
    </view>
    <text class="subtitle">记录生活，连接思想</text>
  </view>

  <!-- 现有用户快速选择 -->
  <view class="login-card" wx:if="{{users.length > 0}}">
    <view class="card-header">
      <text class="welcome-text">快速选择用户</text>
      <text class="welcome-desc">点击头像快速登录</text>
    </view>
    <view class="user-list">
      <view class="user-item" 
            wx:for="{{users}}" 
            wx:key="id"
            bindtap="selectUser"
            data-user-id="{{item.id}}">
        <view class="user-avatar">
          <text>{{item.name.charAt(0)}}</text>
        </view>
        <view class="user-info">
          <text class="user-name">{{item.displayName || item.name}}</text>
          <text class="user-email">{{item.email}}</text>
          <text class="last-login">上次登录：{{item.lastLoginText}}</text>
        </view>
        <view class="user-status">
          <view class="notion-status {{item.notionConfigured ? 'connected' : 'disconnected'}}">
            <text>{{item.notionConfigured ? 'Notion已连接' : 'Notion未配置'}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 已有账号登录 -->
  <view class="existing-user-login">
    <view class="section-header" bindtap="toggleExistingLogin">
      <text class="section-title">已有账号登录</text>
      <text class="toggle-icon">{{showExistingLogin ? '▼' : '▶'}}</text>
    </view>
    <view class="input-group" wx:if="{{showExistingLogin}}">
      <view class="input-item">
        <text class="input-label">邮箱地址</text>
        <input class="input-field" 
               placeholder="请输入已注册的邮箱地址" 
               value="{{loginEmail}}"
               bindinput="onLoginEmailInput"
               type="email"/>
        <view class="input-hint {{loginEmailError ? 'error' : ''}}">
          <text wx:if="{{loginEmailError}}">{{loginEmailError}}</text>
          <text wx:else>输入您注册时使用的邮箱地址</text>
        </view>
      </view>
      <view class="input-item">
        <text class="input-label">密码</text>
        <view class="password-input">
          <input class="input-field password-field" 
                 placeholder="请输入密码" 
                 value="{{loginPassword}}"
                 bindinput="onLoginPasswordInput"
                 password="{{!showPassword}}"
                 type="text"/>
          <view class="password-toggle" bindtap="togglePasswordVisibility">
            <text class="toggle-icon">{{showPassword ? '👁️' : '🙈'}}</text>
          </view>
        </view>
        <view class="input-hint {{loginPasswordError ? 'error' : ''}}">
          <text wx:if="{{loginPasswordError}}">{{loginPasswordError}}</text>
          <text wx:else>输入您的登录密码</text>
        </view>
      </view>
      <view class="remember-password">
        <label class="checkbox-label">
          <checkbox value="remember" checked="{{rememberPassword}}" bindchange="onRememberPasswordChange"/>
          <text>记住密码</text>
        </label>
      </view>
    </view>
    <button class="login-btn" 
            wx:if="{{showExistingLogin}}"
            bindtap="loginWithPassword"
            disabled="{{!loginEmail || !loginPassword || logging}}">
      {{logging ? '登录中...' : '登录'}}
    </button>
    
  </view>

  <!-- 创建新账户 -->
  <view class="login-card">
    <view class="card-header">
      <text class="welcome-text">创建新账户</text>
      <text class="welcome-desc">首次使用请创建账户</text>
    </view>
    <view class="create-user-section">
      <view class="section-header" wx:if="{{users.length > 0}}" bindtap="toggleCreateUser">
        <text class="section-title">注册信息</text>
        <text class="toggle-icon">{{showCreateUser ? '▼' : '▶'}}</text>
      </view>
      <view class="input-group" wx:if="{{showCreateUser || users.length === 0}}">
        <view class="input-item">
          <text class="input-label">邮箱地址</text>
          <input class="input-field" 
                 placeholder="请输入邮箱地址，如：user@example.com" 
                 value="{{newUserEmail}}"
                 bindinput="onUserEmailInput"
                 type="email"/>
          <view class="input-hint {{emailError ? 'error' : ''}}">
            {{emailError || '邮箱将作为您的账户标识，建议使用Notion注册邮箱'}}
          </view>
        </view>
        <view class="input-item">
          <text class="input-label">设置密码</text>
          <view class="password-input">
            <input class="input-field password-field" 
                   placeholder="请设置登录密码（至少6位）" 
                   value="{{newUserPassword}}"
                   bindinput="onUserPasswordInput"
                   password="{{!showPassword}}"
                   type="text"/>
            <view class="password-toggle" bindtap="togglePasswordVisibility">
              <text class="toggle-icon">{{showPassword ? '👁️' : '🙈'}}</text>
            </view>
          </view>
          <view class="input-hint {{passwordError ? 'error' : ''}}">
            {{passwordError || '密码用于保护您的账户安全'}}
          </view>
        </view>
        <view class="input-item">
          <text class="input-label">确认密码</text>
          <view class="password-input">
            <input class="input-field password-field" 
                   placeholder="请再次输入密码" 
                   value="{{newUserPasswordConfirm}}"
                   bindinput="onUserPasswordConfirmInput"
                   password="{{!showConfirmPassword}}"
                   type="text"/>
            <view class="password-toggle" bindtap="toggleConfirmPasswordVisibility">
              <text class="toggle-icon">{{showConfirmPassword ? '👁️' : '🙈'}}</text>
            </view>
          </view>
          <view class="input-hint">请确认您的密码</view>
        </view>
        <view class="input-item">
          <text class="input-label">显示名称（可选）</text>
          <input class="input-field" 
                 placeholder="请输入显示名称" 
                 value="{{newUserName}}"
                 bindinput="onUserNameInput"/>
          <view class="input-hint">不填写将使用邮箱前缀作为显示名称</view>
        </view>
      </view>
      <button class="create-btn" 
              wx:if="{{showCreateUser || users.length === 0}}"
              bindtap="createUser"
              disabled="{{!isEmailValid || !isPasswordValid || creating}}">
        {{creating ? '创建中...' : '创建账户'}}
      </button>
    </view>
  </view>

  <!-- 底部说明 -->
  <view class="footer">
    <text class="footer-text">每个用户的数据独立存储</text>
    <text class="footer-text">支持个人Notion账户连接</text>
  </view>
</view>

<!-- 加载遮罩 -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <text>正在登录...</text>
  </view>
</view>