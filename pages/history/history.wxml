<view class="container">
  <!-- 页面标题说明 -->
  <view class="page-header">
    <view class="header-top">
      <view class="header-left">
        <view class="page-title">⏱️ 我的足迹</view>
        <view class="page-desc">看看时间都去哪了，每一分钟都值得回顾</view>
      </view>
      <view class="refresh-btn" bindtap="onRefresh">
        <text class="refresh-icon">🔄</text>
      </view>
    </view>
  </view>

  <!-- 日期选择和统计 -->
  <view class="header-section">
    <view class="date-selector">
      <picker mode="date" value="{{ selectedDate }}" bindchange="onDateChange" start="2020-01-01" end="{{ todayDate }}">
        <view class="date-picker">
          <text class="date-text">{{ selectedDateDisplay }}</text>
          <text class="date-icon">📅</text>
        </view>
      </picker>
    </view>
    
    <!-- 核心统计卡片 - 只显示有意义的指标 -->
    <view class="stats-grid-simple">
      <view class="stat-card valuable" bindtap="showStatsDebug">
        <view class="stat-icon">✅</view>
        <view class="stat-number">{{ stats.valuableMinutes }}</view>
        <view class="stat-label">分钟</view>
      </view>
      <view class="stat-card wasteful" bindtap="showStatsDebug">
        <view class="stat-icon">⚠️</view>
        <view class="stat-number">{{ stats.wastefulMinutes }}</view>
        <view class="stat-label">分钟</view>
      </view>
    </view>
  </view>

  <!-- 高级筛选 -->
  <view class="advanced-filter">
    <view class="filter-header" bindtap="toggleFilterPanel">
      <text class="filter-title">高级筛选</text>
      <text class="filter-arrow {{ showFilterPanel ? 'active' : '' }}">▼</text>
    </view>
    
    <view class="filter-panel {{ showFilterPanel ? 'show' : '' }}">
      <!-- 标签筛选 -->
      <view class="filter-group">
        <view class="filter-label">标签筛选</view>
        <view class="tag-filter">
          <view class="filter-tag {{ selectedTags.indexOf(item) !== -1 ? 'selected' : '' }}" wx:for="{{ allTags }}" wx:key="index" bindtap="toggleTagFilter" data-tag="{{ item }}">
            {{ item }}
          </view>
        </view>
      </view>

      <!-- 时间范围筛选 -->
      <view class="filter-group">
        <view class="filter-label">时间范围</view>
        <view class="time-range-filter">
          <view class="time-range-item {{ timeRange === item.value ? 'active' : '' }}" wx:for="{{ timeRangeOptions }}" wx:key="value" bindtap="setTimeRange" data-range="{{ item.value }}">
            {{ item.label }}
          </view>
        </view>
      </view>

      <!-- 排序方式 -->
      <view class="filter-group">
        <view class="filter-label">排序方式</view>
        <view class="sort-options">
          <view class="sort-option {{ sortBy === item.value ? 'active' : '' }}" wx:for="{{ sortOptions }}" wx:key="value" bindtap="setSortBy" data-sort="{{ item.value }}">
            {{ item.label }}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 记录列表 -->
  <view class="memo-list" wx:if="{{ filteredMemos.length > 0 }}">
    <!-- 按日期分组显示 -->
    <view class="date-group" wx:for="{{ groupedMemos }}" wx:key="date">
      <view class="date-header">
        <text class="date-title">{{ item.dateDisplay }}</text>
        <text class="date-count">{{ item.memos.length }}条</text>
      </view>
      
      <view class="memo-item" wx:for="{{ item.memos }}" wx:key="id" wx:for-item="memo">
        <!-- 活动时间段列表 - 提升为主要内容 -->
        <view class="activity-list-primary" wx:if="{{ memo.activities && memo.activities.length > 0 }}">
          <view class="activity-header">
            <view class="activity-header-left">
              <text class="activity-period">{{ memo.timePeriodDisplay }}</text>
              <text class="activity-summary">{{ memo.activities.length }}项活动</text>
            </view>
            <view class="activity-actions">
              <text class="action-btn edit-btn" bindtap="editMemo" data-id="{{ memo.id }}">✏️</text>
              <text class="action-btn delete-btn" bindtap="deleteMemo" data-id="{{ memo.id }}">🗑️</text>
            </view>
          </view>
          <view class="activity-item" wx:for="{{ memo.activities }}" wx:key="index" wx:for-item="activity">
            <view class="activity-icon" data-type="{{ activity.activityType }}">
              <text wx:if="{{ activity.activityType.includes('有价值') || activity.activityType === 'valuable' }}">✅</text>
              <text wx:elif="{{ activity.activityType.includes('低效') || activity.activityType === 'wasteful' }}">⚠️</text>
              <text wx:else>📊</text>
            </view>
            <view class="activity-info">
              <view class="activity-name">{{ activity.name }}</view>
              <view class="activity-meta">
                <text class="activity-duration">{{ activity.duration }}分钟</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 无活动明细时显示原记录 -->
        <view class="memo-content-fallback" wx:else>
          <view class="memo-header">
            <view class="memo-header-left">
              <view class="memo-type {{ memo.isPlanning ? 'planning' : memo.type }}">
                <text>{{ memo.isPlanning ? '📋' : (memo.type === 'voice' ? '🎤' : '📝') }}</text>
              </view>
              <view class="memo-time-info">
                <view class="time-period-main">{{ memo.timePeriodDisplay }}</view>
              </view>
            </view>
            <view class="activity-actions">
              <text class="action-btn edit-btn" bindtap="editMemo" data-id="{{ memo.id }}">✏️</text>
              <text class="action-btn delete-btn" bindtap="deleteMemo" data-id="{{ memo.id }}">🗑️</text>
            </view>
          </view>

          <view class="memo-text">{{ memo.content }}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view wx:else class="empty-state">
    <view class="empty-icon">🗂️</view>
    <view class="empty-text">
      <text wx:if="{{ hasActiveFilters }}">没有符合条件的记录</text>
      <text wx:else>暂无历史记录</text>
    </view>
    <button wx:if="{{ hasActiveFilters }}" class="btn btn-secondary" bindtap="clearFilters">
      <text>清除筛选</text>
    </button>
  </view>

  <!-- 加载更多 -->
  <view class="load-more" wx:if="{{ filteredMemos.length > 0 && hasMore }}">
    <button class="btn btn-secondary" bindtap="loadMore" loading="{{ isLoading }}">
      <text>{{ isLoading ? '加载中...' : '加载更多' }}</text>
    </button>
  </view>

  <!-- 悬浮的新建记录按钮 -->
  <view class="float-add-btn" bindtap="createNewRecord">
    <text class="add-icon">✏️</text>
  </view>
</view>