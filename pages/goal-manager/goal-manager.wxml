<view class="container">
  <!-- 目标统计卡片 -->
  <view class="stats-section">
    <view class="stats-card">
      <view class="stats-row">
        <view class="stat-item">
          <view class="stat-number">{{goalStats.total}}</view>
          <view class="stat-label">总目标</view>
        </view>
        <view class="stat-item">
          <view class="stat-number">{{goalStats.active}}</view>
          <view class="stat-label">进行中</view>
        </view>
        <view class="stat-item">
          <view class="stat-number">{{goalStats.completed}}</view>
          <view class="stat-label">已完成</view>
        </view>
        <view class="stat-item">
          <view class="stat-number">{{goalStats.averageProgress}}%</view>
          <view class="stat-label">平均进度</view>
        </view>
      </view>
    </view>
    
    <!-- 快速操作 -->
    <view class="quick-actions">
      <button class="action-btn primary" bindtap="addGoal">
        <text class="icon">🎯</text>
        <text>新建目标</text>
      </button>
      <button class="action-btn secondary" bindtap="showToday">
        <text class="icon">📅</text>
        <text>今日目标</text>
      </button>
      <button class="action-btn secondary" bindtap="showSettings">
        <text class="icon">⚙️</text>
        <text>设置</text>
      </button>
    </view>
  </view>

  <!-- 筛选和搜索 -->
  <view class="filter-section">
    <view class="search-box">
      <input 
        class="search-input" 
        placeholder="搜索目标标题或描述..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="onSearchConfirm"
      />
      <text class="search-icon">🔍</text>
    </view>
    
    <!-- 类型筛选 -->
    <scroll-view class="type-filter" scroll-x="true">
      <view class="filter-item {{selectedType === '' ? 'active' : ''}}" bindtap="filterByType" data-type="">
        全部 ({{goalStats.total}})
      </view>
      <view class="filter-item {{selectedType === 'short' ? 'active' : ''}}" bindtap="filterByType" data-type="short">
        短期 ({{goalStats.shortTerm}})
      </view>
      <view class="filter-item {{selectedType === 'medium' ? 'active' : ''}}" bindtap="filterByType" data-type="medium">
        中期 ({{goalStats.mediumTerm}})
      </view>
      <view class="filter-item {{selectedType === 'long' ? 'active' : ''}}" bindtap="filterByType" data-type="long">
        长期 ({{goalStats.longTerm}})
      </view>
    </scroll-view>
    
    <!-- 状态筛选 -->
    <scroll-view class="status-filter" scroll-x="true">
      <view class="status-chip {{selectedStatus === '' ? 'active' : ''}}" bindtap="filterByStatus" data-status="">
        全部状态
      </view>
      <view class="status-chip {{selectedStatus === 'active' ? 'active' : ''}}" bindtap="filterByStatus" data-status="active">
        进行中
      </view>
      <view class="status-chip {{selectedStatus === 'completed' ? 'active' : ''}}" bindtap="filterByStatus" data-status="completed">
        已完成
      </view>
      <view class="status-chip {{selectedStatus === 'paused' ? 'active' : ''}}" bindtap="filterByStatus" data-status="paused">
        已暂停
      </view>
    </scroll-view>
  </view>

  <!-- 目标列表 -->
  <view class="goals-section">
    <view class="section-header">
      <view class="section-title">
        <text class="icon">📋</text>
        <text>目标列表 ({{filteredGoals.length}})</text>
      </view>
      <view class="sort-options">
        <picker bindchange="onSortChange" value="{{sortIndex}}" range="{{sortOptions}}" range-key="label">
          <view class="sort-btn">
            <text>{{sortOptions[sortIndex].label}}</text>
            <text class="arrow">▼</text>
          </view>
        </picker>
      </view>
    </view>

    <scroll-view class="goals-list" scroll-y="true">
      <view 
        class="goal-item goal-{{goal.type}} priority-{{goal.priority}}" 
        wx:for="{{filteredGoals}}" 
        wx:key="id"
        wx:for-item="goal"
      >
        <view class="goal-header">
          <view class="goal-title">{{goal.title}}</view>
          <view class="goal-actions">
            <view class="action-icon" bindtap="toggleGoalStatus" data-id="{{goal.id}}">
              <text>{{goal.status === 'active' ? '⏸️' : goal.status === 'completed' ? '✅' : '▶️'}}</text>
            </view>
            <view class="action-icon" bindtap="editGoal" data-id="{{goal.id}}">
              <text>✏️</text>
            </view>
          </view>
        </view>
        
        <view class="goal-content">
          <view class="goal-description" wx:if="{{goal.description}}">{{goal.description}}</view>
          
          <!-- 进度条 -->
          <view class="progress-section">
            <view class="progress-header">
              <text class="progress-label">进度</text>
              <text class="progress-value">{{goal.progress}}%</text>
            </view>
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{goal.progress}}%"></view>
            </view>
          </view>
          
          <!-- 目标标签 -->
          <view class="goal-meta">
            <view class="goal-tags">
              <view class="type-tag type-{{goal.type}}">{{goal.type === 'short' ? '短期' : goal.type === 'medium' ? '中期' : '长期'}}</view>
              <view class="priority-tag priority-{{goal.priority}}">{{goal.priority === 'high' ? '高优先级' : goal.priority === 'low' ? '低优先级' : '中优先级'}}</view>
              <view class="category-tag">{{goal.category}}</view>
              <view class="deadline-tag" wx:if="{{goal.targetDate}}">
                {{goal.deadlineText}}
              </view>
            </view>
            <view class="goal-info">
              <text class="milestone-count" wx:if="{{goal.milestones.length > 0}}">
                📍 {{goal.completedMilestones}}/{{goal.milestones.length}} 里程碑
              </text>
              <text class="memo-count" wx:if="{{goal.relatedMemos.length > 0}}">
                📝 {{goal.relatedMemos.length}} 条记录
              </text>
              <text class="time-investment" wx:if="{{goal.totalTimeInvestment > 0}}">
                ⏱️ 已投入 {{goal.timeInvestmentDisplay}}
              </text>
            </view>
          </view>
        </view>
        
        <!-- 里程碑列表 -->
        <view class="milestones-section" wx:if="{{goal.milestones.length > 0}}">
          <view class="milestones-header" bindtap="toggleMilestones" data-id="{{goal.id}}">
            <text class="milestones-title">里程碑 ({{goal.completedMilestones}}/{{goal.milestones.length}})</text>
            <text class="toggle-icon">{{goal.showMilestones ? '▼' : '▶'}}</text>
          </view>
          <view class="milestones-list" wx:if="{{goal.showMilestones}}">
            <view 
              class="milestone-item {{milestone.completed ? 'completed' : ''}}"
              wx:for="{{goal.milestones}}"
              wx:key="id"
              wx:for-item="milestone"
            >
              <view class="milestone-header">
                <view class="milestone-title">{{milestone.title}}</view>
                <view class="milestone-status" bindtap="toggleMilestone" data-goal-id="{{goal.id}}" data-milestone-id="{{milestone.id}}">
                  <text class="status-icon">{{milestone.completed ? '✅' : '⭕'}}</text>
                </view>
              </view>
              <view class="milestone-date" wx:if="{{milestone.targetDate}}">
                目标: {{milestone.targetDateText}}
              </view>
            </view>
          </view>
        </view>
        
        <!-- 操作按钮 -->
        <view class="goal-actions-row">
          <button class="btn-action" bindtap="addMilestone" data-id="{{goal.id}}">
            <text>📍 添加里程碑</text>
          </button>
          <button class="btn-action" bindtap="updateProgress" data-id="{{goal.id}}">
            <text>📊 更新进度</text>
          </button>
          <button class="btn-action" bindtap="viewGoalDetail" data-id="{{goal.id}}">
            <text>👁️ 查看详情</text>
          </button>
        </view>
      </view>
      
      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{filteredGoals.length === 0}}">
        <text class="empty-icon">🎯</text>
        <text class="empty-text">{{searchKeyword ? '暂无符合条件的目标' : '还没有设定目标'}}</text>
        <button class="empty-action" bindtap="addGoal">设定第一个目标</button>
      </view>
    </scroll-view>
  </view>

  <!-- 添加/编辑目标弹窗 -->
  <view class="modal {{showAddModal ? 'show' : ''}}" wx:if="{{showAddModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{editingGoal ? '编辑目标' : '新建目标'}}</text>
        <text class="close-btn" bindtap="closeAddModal">✕</text>
      </view>
      
      <view class="form-group">
        <label class="form-label">目标标题 *</label>
        <input 
          class="form-input" 
          placeholder="如：学会弹吉他、减重10公斤..." 
          value="{{formData.title}}"
          bindinput="onTitleInput"
          maxlength="50"
        />
      </view>
      
      <view class="form-group">
        <label class="form-label">目标描述</label>
        <textarea 
          class="form-textarea" 
          placeholder="详细描述这个目标的具体内容和意义..." 
          value="{{formData.description}}"
          bindinput="onDescriptionInput"
          maxlength="200"
        ></textarea>
      </view>
      
      <view class="form-group">
        <label class="form-label">目标类型 *</label>
        <picker bindchange="onTypeChange" value="{{typeIndex}}" range="{{typeOptions}}" range-key="label">
          <view class="picker-input">
            <text>{{typeOptions[typeIndex].label}}</text>
            <text class="arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-group">
        <label class="form-label">目标分类</label>
        <picker bindchange="onCategoryChange" value="{{categoryIndex}}" range="{{categoryOptions}}">
          <view class="picker-input">
            <text>{{formData.category}}</text>
            <text class="arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-group">
        <label class="form-label">优先级</label>
        <picker bindchange="onPriorityChange" value="{{priorityIndex}}" range="{{priorityOptions}}" range-key="label">
          <view class="picker-input">
            <text>{{priorityOptions[priorityIndex].label}}</text>
            <text class="arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-group">
        <label class="form-label">目标截止日期</label>
        <picker mode="date" value="{{targetDate}}" bindchange="onTargetDateChange">
          <view class="picker-input">
            <text>{{targetDate || '选择日期'}}</text>
            <text class="arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-group">
        <label class="form-label">标签 (用空格分隔)</label>
        <input 
          class="form-input" 
          placeholder="如: 健康 技能 学习" 
          value="{{tagsInput}}"
          bindinput="onTagsInput"
        />
      </view>
      
      <view class="form-actions">
        <button class="btn-cancel" bindtap="closeAddModal">取消</button>
        <button class="btn-confirm" bindtap="confirmAddGoal" disabled="{{!formData.title}}">
          {{editingGoal ? '保存' : '创建'}}
        </button>
      </view>
    </view>
  </view>

  <!-- 里程碑弹窗 -->
  <view class="modal {{showMilestoneModal ? 'show' : ''}}" wx:if="{{showMilestoneModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">添加里程碑</text>
        <text class="close-btn" bindtap="closeMilestoneModal">✕</text>
      </view>
      
      <view class="form-group">
        <label class="form-label">里程碑标题 *</label>
        <input 
          class="form-input" 
          placeholder="如：完成第一章练习..." 
          value="{{milestoneData.title}}"
          bindinput="onMilestoneTitleInput"
          maxlength="30"
        />
      </view>
      
      <view class="form-group">
        <label class="form-label">里程碑描述</label>
        <textarea 
          class="form-textarea" 
          placeholder="详细描述这个里程碑..." 
          value="{{milestoneData.description}}"
          bindinput="onMilestoneDescriptionInput"
          maxlength="100"
        ></textarea>
      </view>
      
      <view class="form-group">
        <label class="form-label">目标完成日期</label>
        <picker mode="date" value="{{milestoneTargetDate}}" bindchange="onMilestoneTargetDateChange">
          <view class="picker-input">
            <text>{{milestoneTargetDate || '选择日期'}}</text>
            <text class="arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-actions">
        <button class="btn-cancel" bindtap="closeMilestoneModal">取消</button>
        <button class="btn-confirm" bindtap="confirmAddMilestone" disabled="{{!milestoneData.title}}">
          添加
        </button>
      </view>
    </view>
  </view>

  <!-- 进度更新弹窗 -->
  <view class="modal {{showProgressModal ? 'show' : ''}}" wx:if="{{showProgressModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">更新进度</text>
        <text class="close-btn" bindtap="closeProgressModal">✕</text>
      </view>
      
      <view class="form-group">
        <label class="form-label">当前进度：{{progressValue}}%</label>
        <slider 
          value="{{progressValue}}" 
          min="0" 
          max="100" 
          step="5"
          show-value
          bindchange="onProgressChange"
          activeColor="#6366f1"
          backgroundColor="#e5e7eb"
        />
      </view>
      
      <view class="form-actions">
        <button class="btn-cancel" bindtap="closeProgressModal">取消</button>
        <button class="btn-confirm" bindtap="confirmUpdateProgress">
          更新进度
        </button>
      </view>
    </view>
  </view>
</view>