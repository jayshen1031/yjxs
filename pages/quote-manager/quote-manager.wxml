<wxs module="utils">
function getCategoryClass(category) {
  var categoryMap = {
    'åŠ±å¿—': 'inspire',
    'ç”Ÿæ´»': 'life',
    'æˆé•¿': 'growth',
    'å“²ç†': 'philosophy',
    'è®°å½•': 'record',
    'æ—¶é—´': 'time',
    'åšæŒ': 'persist',
    'æ„Ÿæ‚Ÿ': 'insight',
    'ä¹ æƒ¯': 'habit',
    'æ¢¦æƒ³': 'dream'
  }
  return categoryMap[category] || 'custom'
}

// æ ‡ç­¾å»é‡
function uniqueTags(tags) {
  var seen = {}
  var result = []
  for (var i = 0; i < tags.length; i++) {
    if (!seen[tags[i]]) {
      seen[tags[i]] = true
      result.push(tags[i])
    }
  }
  return result
}

module.exports = {
  getCategoryClass: getCategoryClass,
  uniqueTags: uniqueTags
}
</wxs>

<view class="container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stat-card">
      <view class="stat-icon">â­</view>
      <view class="stat-info">
        <view class="stat-number">{{systemQuotes.length}}</view>
        <view class="stat-label">ç³»ç»Ÿç®´è¨€</view>
      </view>
    </view>
    <view class="stat-card">
      <view class="stat-icon">âœï¸</view>
      <view class="stat-info">
        <view class="stat-number">{{myQuotes.length}}</view>
        <view class="stat-label">æˆ‘çš„ç®´è¨€</view>
      </view>
    </view>
    <view class="stat-card">
      <view class="stat-icon">ğŸ“Š</view>
      <view class="stat-info">
        <view class="stat-number">{{categories.length}}</view>
        <view class="stat-label">åˆ†ç±»</view>
      </view>
    </view>
  </view>

  <!-- Tabåˆ‡æ¢ -->
  <view class="tab-bar">
    <view class="tab-item {{activeTab === 'system' ? 'active' : ''}}" bindtap="switchTab" data-tab="system">
      <text class="tab-icon">â­</text>
      <text class="tab-label">ç³»ç»Ÿç®´è¨€</text>
    </view>
    <view class="tab-item {{activeTab === 'my' ? 'active' : ''}}" bindtap="switchTab" data-tab="my">
      <text class="tab-icon">âœï¸</text>
      <text class="tab-label">æˆ‘çš„ç®´è¨€</text>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="filter-bar">
    <view class="search-box">
      <text class="search-icon">ğŸ”</text>
      <input
        class="search-input"
        placeholder="æœç´¢ç®´è¨€..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
      />
    </view>
    <view class="filter-btn" bindtap="showFilterModal">
      <text>ç­›é€‰</text>
      <text class="filter-count" wx:if="{{activeFilters > 0}}">{{activeFilters}}</text>
    </view>
    <view class="add-btn" bindtap="addQuote">
      <text>â•</text>
    </view>
  </view>

  <!-- åˆ†ç±»ç­›é€‰æ¡ -->
  <scroll-view class="category-scroll" scroll-x="true">
    <view class="category-chip {{selectedCategory === '' ? 'active' : ''}}" bindtap="filterByCategory" data-category="">
      å…¨éƒ¨
    </view>
    <view
      class="category-chip {{selectedCategory === item ? 'active' : ''}}"
      wx:for="{{categories}}"
      wx:key="*this"
      bindtap="filterByCategory"
      data-category="{{item}}"
    >
      {{item}}
      <text class="chip-count">{{categoriesData[item]}}</text>
    </view>
  </scroll-view>

  <!-- ç®´è¨€åˆ—è¡¨ -->
  <scroll-view class="quotes-scroll" scroll-y="true">
    <!-- ç³»ç»Ÿç®´è¨€ Tab -->
    <view wx:if="{{activeTab === 'system'}}">
      <view class="quote-card" wx:for="{{systemQuotes}}" wx:key="id">
        <view class="card-header">
          <view class="source-badge notion">
            <text>â­ ç³»ç»Ÿ</text>
          </view>
          <view class="card-actions">
            <text class="action-icon" bindtap="useThisQuote" data-id="{{item.id}}">âš¡</text>
          </view>
        </view>
        <view class="quote-text">{{item.content}}</view>
        <view class="quote-meta">
          <view class="category-badge category-{{utils.getCategoryClass(item.category)}}">{{item.category}}</view>
          <view class="tags-wrapper" wx:if="{{item.tags && item.tags.length > 0}}">
            <text class="tag" wx:for="{{utils.uniqueTags(item.tags)}}" wx:key="*this" wx:for-item="tag">
              #{{tag}}
            </text>
          </view>
        </view>
        <view class="card-footer">
          <text class="usage-text">ä½¿ç”¨ {{item.usageCount || 0}} æ¬¡</text>
          <text class="source-text">{{item.source || 'ç³»ç»Ÿ'}}</text>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{systemQuotes.length === 0}}">
        <text class="empty-icon">â­</text>
        <text class="empty-text">æš‚æ— ç³»ç»Ÿç®´è¨€</text>
      </view>
    </view>

    <!-- æˆ‘çš„ç®´è¨€ Tab -->
    <view wx:if="{{activeTab === 'my'}}">
      <view class="quote-card" wx:for="{{myQuotes}}" wx:key="id">
        <view class="card-header">
          <view class="source-badge local">
            <text>{{item.isPinned ? 'ğŸ“Œ å›ºå®š' : 'âœï¸ æˆ‘çš„'}}</text>
          </view>
          <view class="card-actions">
            <text class="action-icon" bindtap="editQuote" data-id="{{item.id}}">âœï¸</text>
            <text class="action-icon" bindtap="deleteQuote" data-id="{{item.id}}">ğŸ—‘ï¸</text>
            <text class="action-icon" bindtap="useThisQuote" data-id="{{item.id}}">âš¡</text>
          </view>
        </view>
        <view class="quote-text">{{item.content}}</view>
        <view class="quote-meta">
          <view class="category-badge category-{{utils.getCategoryClass(item.category)}}">{{item.category}}</view>
          <view class="tags-wrapper" wx:if="{{item.tags && item.tags.length > 0}}">
            <text class="tag" wx:for="{{utils.uniqueTags(item.tags)}}" wx:key="*this" wx:for-item="tag">
              #{{tag}}
            </text>
          </view>
        </view>
        <view class="card-footer">
          <text class="usage-text">ä½¿ç”¨ {{item.usageCount || 0}} æ¬¡</text>
          <text class="time-text">{{item.createdTime || 'åˆšåˆšæ·»åŠ '}}</text>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{myQuotes.length === 0}}">
        <text class="empty-icon">âœï¸</text>
        <text class="empty-text">è¿˜æ²¡æœ‰æ·»åŠ ç®´è¨€</text>
        <text class="empty-hint">ç‚¹å‡»å³ä¸Šè§’ â• æ·»åŠ ä½ çš„ç®´è¨€</text>
        <button class="empty-btn" bindtap="addQuote">æ·»åŠ ç¬¬ä¸€æ¡ç®´è¨€</button>
      </view>
    </view>
  </scroll-view>

  <!-- æ·»åŠ /ç¼–è¾‘ç®´è¨€å¼¹çª— -->
  <view class="modal-mask {{showAddModal ? 'show' : ''}}" bindtap="closeAddModal" wx:if="{{showAddModal}}">
    <view class="modal-dialog" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{editingQuote ? 'âœï¸ ç¼–è¾‘ç®´è¨€' : 'â• æ·»åŠ ç®´è¨€'}}</text>
        <text class="close-icon" bindtap="closeAddModal">âœ•</text>
      </view>

      <view class="modal-body">
        <view class="form-item">
          <view class="form-label">ç®´è¨€å†…å®¹ <text class="required">*</text></view>
          <textarea
            class="form-textarea"
            placeholder="è¾“å…¥æ¿€åŠ±äººå¿ƒçš„ç®´è¨€..."
            value="{{formData.content}}"
            bindinput="onContentInput"
            maxlength="200"
            auto-height
          ></textarea>
          <view class="char-hint">{{formData.content.length}}/200</view>
        </view>

        <view class="form-item">
          <view class="form-label">åˆ†ç±»</view>
          <picker bindchange="onCategoryChange" value="{{categoryIndex}}" range="{{categoryOptions}}">
            <view class="form-picker">
              <text>{{formData.category}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>

        <view class="form-item">
          <view class="form-label">æ ‡ç­¾ <text class="form-hint">(ç”¨ç©ºæ ¼åˆ†éš”)</text></view>
          <input
            class="form-input"
            placeholder="ä¾‹å¦‚: æ­£èƒ½é‡ å®ç”¨ æ·±åº¦æ€è€ƒ"
            value="{{tagsInput}}"
            bindinput="onTagsInput"
          />
          <view class="tags-preview" wx:if="{{formData.tags.length > 0}}">
            <text class="tag-preview" wx:for="{{utils.uniqueTags(formData.tags)}}" wx:key="*this">
              #{{item}}
            </text>
          </view>
        </view>

        <view class="form-item">
          <view class="form-label">æ¥æº</view>
          <input
            class="form-input"
            placeholder="ä¾‹å¦‚: æŸæŸä¹¦ç±ã€æŸæŸåäºº"
            value="{{formData.source}}"
            bindinput="onSourceInput"
          />
        </view>

        <view class="form-item">
          <label class="checkbox-label">
            <checkbox
              checked="{{formData.isPinned}}"
              bindchange="onPinnedChange"
            />
            <text class="checkbox-text">ğŸ“Œ å›ºå®šç®´è¨€ï¼ˆæ¯å¤©å¿…çœ‹ï¼‰</text>
          </label>
          <view class="form-hint">å›ºå®šçš„ç®´è¨€ä¼šä¼˜å…ˆæ˜¾ç¤ºåœ¨é¦–é¡µ</view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn btn-cancel" bindtap="closeAddModal">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="confirmAddQuote" disabled="{{!formData.content}}">
          {{editingQuote ? 'ä¿å­˜' : 'æ·»åŠ '}}
        </button>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <view class="modal-mask {{showFilterModal ? 'show' : ''}}" bindtap="closeFilterModal" wx:if="{{showFilterModal}}">
    <view class="modal-dialog" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ğŸ” ç­›é€‰æ¡ä»¶</text>
        <text class="close-icon" bindtap="closeFilterModal">âœ•</text>
      </view>

      <view class="modal-body">
        <view class="filter-section">
          <view class="filter-title">æ’åºæ–¹å¼</view>
          <picker bindchange="onSortChange" value="{{sortIndex}}" range="{{sortOptions}}" range-key="label">
            <view class="form-picker">
              <text>{{sortOptions[sortIndex].label}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>

        <view class="filter-section">
          <view class="filter-title">æ¥æº</view>
          <view class="filter-chips">
            <view class="filter-chip {{sourceFilter === 'all' ? 'active' : ''}}" bindtap="filterBySource" data-source="all">
              å…¨éƒ¨
            </view>
            <view class="filter-chip {{sourceFilter === 'notion' ? 'active' : ''}}" bindtap="filterBySource" data-source="notion">
              â˜ï¸ Notion
            </view>
            <view class="filter-chip {{sourceFilter === 'local' ? 'active' : ''}}" bindtap="filterBySource" data-source="local">
              ğŸ“± æœ¬åœ°
            </view>
            <view class="filter-chip {{sourceFilter === 'system' ? 'active' : ''}}" bindtap="filterBySource" data-source="system">
              â­ ç³»ç»Ÿ
            </view>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn btn-text" bindtap="resetFilters">é‡ç½®</button>
        <button class="btn btn-primary" bindtap="applyFilters">åº”ç”¨</button>
      </view>
    </view>
  </view>
</view>
