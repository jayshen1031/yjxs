<!--pages/knowledge/knowledge.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-card">
    <view class="stat-item">
      <text class="stat-number">{{stats.total}}</text>
      <text class="stat-label">æ€»è®¡</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{stats.favoriteCount}}</text>
      <text class="stat-label">æ”¶è—</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{filteredList.length}}</text>
      <text class="stat-label">å½“å‰</text>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <input
      class="search-input"
      placeholder="æœç´¢çŸ¥è¯†..."
      value="{{searchKeyword}}"
      bindinput="onSearch"
    />
  </view>

  <!-- åˆ†ç±»é€‰æ‹© -->
  <view class="category-tabs">
    <scroll-view scroll-x class="category-scroll">
      <view
        wx:for="{{categories}}"
        wx:key="index"
        class="category-item {{selectedCategory === item ? 'active' : ''}}"
        data-category="{{item}}"
        bindtap="switchCategory"
      >
        {{item}}
      </view>
    </scroll-view>
  </view>

  <!-- çŸ¥è¯†åˆ—è¡¨ -->
  <view class="knowledge-list">
    <block wx:if="{{loading}}">
      <view class="loading-container">
        <text>åŠ è½½ä¸­...</text>
      </view>
    </block>

    <block wx:elif="{{filteredList.length === 0}}">
      <view class="empty-container">
        <text class="empty-icon">ğŸ“š</text>
        <text class="empty-text">æš‚æ— çŸ¥è¯†æ¡ç›®</text>
        <text class="empty-hint">ç‚¹å‡»å³ä¸‹è§’æ·»åŠ æŒ‰é’®åˆ›å»º</text>
      </view>
    </block>

    <block wx:else>
      <view
        wx:for="{{filteredList}}"
        wx:key="id"
        class="knowledge-card"
      >
      <view class="card-header">
        <text class="card-title">{{item.title}}</text>
        <view class="card-badges">
          <text class="badge category-badge">{{item.category}}</text>
          <text class="badge importance-badge importance-{{item.importance === 'æ ¸å¿ƒ' ? 'core' : item.importance === 'é‡è¦' ? 'important' : 'normal'}}">{{item.importance}}</text>
        </view>
      </view>

      <view class="card-content">
        <text class="card-preview">{{item.preview || item.content || 'æš‚æ— å†…å®¹'}}</text>
      </view>

      <view class="card-meta">
        <text class="meta-item">ğŸ“– {{item.readCount || 0}}æ¬¡</text>
        <text class="meta-item">ğŸ“ {{item.source}}</text>
        <text class="meta-item">ğŸ• {{item.createdTime}}</text>
      </view>

      <view class="card-tags" wx:if="{{item.tags && item.tags.length > 0}}">
        <text
          wx:for="{{item.tags}}"
          wx:for-item="tag"
          wx:key="tag"
          class="tag"
        >
          #{{tag}}
        </text>
      </view>

      <view class="card-actions">
        <button
          class="action-btn view-btn"
          data-id="{{item.id}}"
          bindtap="viewDetail"
        >
          æŸ¥çœ‹
        </button>
        <button
          class="action-btn favorite-btn {{item.isFavorite ? 'active' : ''}}"
          data-id="{{item.id}}"
          bindtap="toggleFavorite"
        >
          {{item.isFavorite ? 'â˜…' : 'â˜†'}}
        </button>
        <button
          class="action-btn delete-btn"
          data-id="{{item.id}}"
          bindtap="deleteKnowledge"
        >
          åˆ é™¤
        </button>
      </view>
      </view>
    </block>
  </view>

  <!-- æ·»åŠ æŒ‰é’® -->
  <view class="fab" bindtap="showAddDialog">
    <text class="fab-icon">+</text>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
  <view class="modal" wx:if="{{showAddModal}}" bindtap="hideModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{editingId ? 'ç¼–è¾‘çŸ¥è¯†' : 'æ·»åŠ çŸ¥è¯†'}}</text>
        <text class="modal-close" bindtap="hideModal">âœ•</text>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">æ ‡é¢˜ *</text>
          <input
            class="form-input"
            placeholder="è¯·è¾“å…¥æ ‡é¢˜"
            value="{{formData.title}}"
            data-field="title"
            bindinput="onFormInput"
          />
        </view>

        <view class="form-group">
          <text class="form-label">å†…å®¹</text>
          <textarea
            class="form-textarea"
            placeholder="è¯·è¾“å…¥å†…å®¹"
            value="{{formData.content}}"
            data-field="content"
            bindinput="onFormInput"
            maxlength="2000"
          />
        </view>

        <view class="form-group">
          <text class="form-label">åˆ†ç±»</text>
          <picker
            mode="selector"
            range="{{categories}}"
            value="{{selectedCategory}}"
            bindchange="onCategoryChange"
          >
            <view class="picker">
              {{formData.category || 'è¯·é€‰æ‹©'}}
            </view>
          </picker>
        </view>

        <view class="form-row">
          <view class="form-group half">
            <text class="form-label">æ¥æº</text>
            <picker
              mode="selector"
              range="['ä¹¦ç±', 'æ–‡ç« ', 'è§†é¢‘', 'è¯¾ç¨‹', 'å®è·µ', 'äº¤æµ', 'å…¶ä»–']"
              bindchange="onSourceChange"
            >
              <view class="picker">
                {{formData.source || 'è¯·é€‰æ‹©'}}
              </view>
            </picker>
          </view>

          <view class="form-group half">
            <text class="form-label">é‡è¦æ€§</text>
            <picker
              mode="selector"
              range="['æ ¸å¿ƒ', 'é‡è¦', 'ä¸€èˆ¬']"
              bindchange="onImportanceChange"
            >
              <view class="picker">
                {{formData.importance || 'è¯·é€‰æ‹©'}}
              </view>
            </picker>
          </view>
        </view>

        <view class="form-actions">
          <button class="cancel-btn" bindtap="hideModal">å–æ¶ˆ</button>
          <button class="save-btn" bindtap="saveKnowledge">ä¿å­˜</button>
        </view>
      </view>
    </view>
  </view>
</view>
