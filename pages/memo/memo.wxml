<view class="container">
  <!-- 记录输入区域 -->
  <view class="input-section fade-in">
    <view class="card">
      <view class="card-content">
        <view class="title">📝 时间投入记录</view>
        <view class="value-tip">
          <text class="tip-icon">🎯</text>
          <text class="tip-text">按时间顺序记录活动，每个活动独立标记价值类型</text>
        </view>

        <!-- 时间选择区域 -->
        <view class="time-selection">
          <!-- 日期类型选择 -->
          <view class="date-type-selector">
            <view
              class="date-type-option {{ selectedDateType === 'today' ? 'active' : '' }}"
              bindtap="selectDateType"
              data-type="today"
            >
              <text class="date-type-label">今天</text>
            </view>
            <view
              class="date-type-option {{ selectedDateType === 'yesterday' ? 'active' : '' }}"
              bindtap="selectDateType"
              data-type="yesterday"
            >
              <text class="date-type-label">昨天</text>
            </view>
            <view
              class="date-type-option {{ selectedDateType === 'custom' ? 'active' : '' }}"
              bindtap="selectDateType"
              data-type="custom"
            >
              <text class="date-type-label">自定义</text>
            </view>
          </view>

          <!-- 自定义日期选择(仅在选择自定义时显示) -->
          <view wx:if="{{ selectedDateType === 'custom' }}" class="custom-date-picker">
            <picker
              mode="date"
              value="{{ customDate }}"
              bindchange="onDateChange"
              start="2024-01-01"
              end="{{ todayDate }}"
            >
              <view class="picker-display">
                <text class="picker-icon">📅</text>
                <text class="picker-text">{{ customDateDisplay || '选择日期' }}</text>
                <text class="picker-arrow">▼</text>
              </view>
            </picker>
          </view>

          <!-- 时间段选择 -->
          <view class="time-range-selector">
            <!-- 开始时间 -->
            <view class="time-picker-group">
              <text class="time-label">开始</text>
              <picker
                mode="selector"
                range="{{ timeOptions }}"
                range-key="label"
                value="{{ startTimeIndex }}"
                bindchange="onStartTimeChange"
              >
                <view class="picker-display">
                  <text class="picker-icon">⏰</text>
                  <text class="picker-text">{{ startTimeDisplay || '选择时间' }}</text>
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>

            <!-- 连接线 -->
            <text class="time-separator">→</text>

            <!-- 结束时间 -->
            <view class="time-picker-group">
              <text class="time-label">结束</text>
              <picker
                mode="selector"
                range="{{ timeOptions }}"
                range-key="label"
                value="{{ endTimeIndex }}"
                bindchange="onEndTimeChange"
              >
                <view class="picker-display">
                  <text class="picker-icon">⏰</text>
                  <text class="picker-text">{{ endTimeDisplay || '选择时间' }}</text>
                  <text class="picker-arrow">▼</text>
                </view>
              </picker>
            </view>
          </view>

          <!-- 选中时间显示 -->
          <view class="selected-time-display">
            <text class="time-display-icon">📍</text>
            <text class="time-display-text">{{ selectedTimeDisplay }}</text>
          </view>
        </view>

        <!-- 已添加的活动列表 -->
        <view wx:if="{{ allActivities.length > 0 }}" class="activities-list">
          <view class="activities-header">
            <text class="header-title">已添加活动</text>
            <view class="stats-summary">
              <text wx:if="{{ totalValuableMinutes > 0 }}" class="stat-item valuable">✅ {{ totalValuableMinutes }}分</text>
              <text wx:if="{{ totalNeutralMinutes > 0 }}" class="stat-item neutral">📊 {{ totalNeutralMinutes }}分</text>
              <text wx:if="{{ totalWastefulMinutes > 0 }}" class="stat-item wasteful">⚠️ {{ totalWastefulMinutes }}分</text>
            </view>
          </view>

          <view class="activity-item" wx:for="{{ allActivities }}" wx:key="index">
            <view class="activity-main">
              <view class="activity-type-icon">
                <text wx:if="{{ item.activityType === 'valuable' }}">✅</text>
                <text wx:elif="{{ item.activityType === 'neutral' }}">📊</text>
                <text wx:else>⚠️</text>
              </view>
              <view class="activity-info">
                <view class="activity-name">{{ item.activity }}</view>
                <view class="activity-meta">
                  <text class="activity-duration">{{ item.minutes }}分钟</text>
                  <view wx:if="{{ item.tags && item.tags.length > 0 }}" class="activity-tags">
                    <text class="tag-item" wx:for="{{ item.tags }}" wx:key="tag" wx:for-item="tag">{{ tag }}</text>
                  </view>
                </view>
                <!-- 关联信息 -->
                <view wx:if="{{ item.goalTitle || item.todoTitle }}" class="activity-associations">
                  <text wx:if="{{ item.goalTitle }}" class="association-item goal">🎯 {{ item.goalTitle }}</text>
                  <text wx:if="{{ item.todoTitle }}" class="association-item todo">✅ {{ item.todoTitle }}</text>
                </view>
              </view>
              <button class="delete-btn" bindtap="removeActivity" data-index="{{ index }}">
                <text class="delete-icon">🗑️</text>
              </button>
            </view>
          </view>

          <view class="total-summary">
            <text class="total-label">总计：</text>
            <text class="total-value">{{ totalMinutes }}分钟 ({{ allActivities.length }}项活动)</text>
          </view>
        </view>

        <!-- 添加新活动表单 -->
        <view class="add-activity-form">
          <view class="form-header">
            <text class="form-title">➕ 添加新活动</text>
          </view>

          <!-- 活动名称 -->
          <view class="form-field">
            <view class="field-label">活动名称</view>
            <input
              class="field-input"
              placeholder="如：晨读、通勤、刷手机..."
              value="{{ currentActivity }}"
              bindinput="onActivityInput"
              maxlength="100"
            />
          </view>

          <!-- 时长 -->
          <view class="form-field">
            <view class="field-label">时长 (分钟)</view>
            <input
              class="field-input number-input"
              type="number"
              placeholder="最小5分钟"
              value="{{ currentMinutes }}"
              bindinput="onMinutesInput"
            />
            <text class="field-hint">5分钟为最小单位</text>
          </view>

          <!-- 价值类型选择 -->
          <view class="form-field">
            <view class="field-label">价值类型</view>
            <view class="activity-type-selector">
              <view
                class="type-option {{ currentActivityType === 'valuable' ? 'active' : '' }}"
                bindtap="selectActivityType"
                data-type="valuable"
              >
                <text class="type-icon">🌟</text>
                <text class="type-label">有价值</text>
              </view>
              <view
                class="type-option {{ currentActivityType === 'neutral' ? 'active' : '' }}"
                bindtap="selectActivityType"
                data-type="neutral"
              >
                <text class="type-icon">😐</text>
                <text class="type-label">中性</text>
              </view>
              <view
                class="type-option {{ currentActivityType === 'wasteful' ? 'active' : '' }}"
                bindtap="selectActivityType"
                data-type="wasteful"
              >
                <text class="type-icon">🗑️</text>
                <text class="type-label">低效</text>
              </view>
            </view>
          </view>

          <!-- 标签选择 -->
          <view class="form-field">
            <view class="field-label">🏷️ 标签 (可选)</view>
            <view wx:if="{{ availableTags.length > 0 }}" class="tags-selector">
              <view
                class="tag-option {{ currentActivityTags.indexOf(tag) !== -1 ? 'selected' : '' }}"
                wx:for="{{ availableTags }}"
                wx:key="index"
                wx:for-item="tag"
                bindtap="toggleActivityTag"
                data-tag="{{ tag }}"
              >
                {{ tag }}
              </view>
            </view>
            <view wx:else class="empty-tags-hint">
              <text class="hint-icon">📝</text>
              <text class="hint-text">暂无标签，使用tagManager添加</text>
            </view>
          </view>

          <!-- 关联目标 -->
          <view class="form-field">
            <view class="field-label">🎯 关联目标 (可选)</view>
            <picker
              wx:if="{{ availableGoals.length > 0 }}"
              mode="selector"
              range="{{ availableGoals }}"
              range-key="title"
              value="{{ currentActivityGoalIndex }}"
              bindchange="onGoalChange"
            >
              <view class="picker-display">
                <text class="picker-text">{{ currentActivityGoalIndex >= 0 ? availableGoals[currentActivityGoalIndex].title : '点击选择目标' }}</text>
                <text class="picker-arrow">▼</text>
              </view>
            </picker>
            <view wx:else class="picker-display disabled">
              <text class="picker-text hint">暂无目标，请先在目标页面创建</text>
            </view>
          </view>

          <!-- 关联待办 -->
          <view class="form-field">
            <view class="field-label">✅ 关联待办 (可选)</view>
            <picker
              wx:if="{{ availableTodos.length > 0 }}"
              mode="selector"
              range="{{ availableTodos }}"
              range-key="title"
              value="{{ currentActivityTodoIndex }}"
              bindchange="onTodoChange"
            >
              <view class="picker-display">
                <text class="picker-text">{{ currentActivityTodoIndex >= 0 ? availableTodos[currentActivityTodoIndex].title : '点击选择待办' }}</text>
                <text class="picker-arrow">▼</text>
              </view>
            </picker>
            <view wx:else class="picker-display disabled">
              <text class="picker-text hint">暂无待办，请先在待办页面创建</text>
            </view>
          </view>

          <!-- 待办状态 (仅当关联了待办时显示) -->
          <view class="form-field" wx:if="{{ currentActivityTodoIndex >= 0 }}">
            <view class="field-label">待办状态</view>
            <view class="status-selector">
              <view
                class="status-option {{ currentActivityTodoStatus === '进行中' ? 'active' : '' }}"
                bindtap="selectTodoStatus"
                data-status="进行中"
              >
                <text class="status-icon">▶️</text>
                <text class="status-label">进行中</text>
              </view>
              <view
                class="status-option {{ currentActivityTodoStatus === '已完成' ? 'active' : '' }}"
                bindtap="selectTodoStatus"
                data-status="已完成"
              >
                <text class="status-icon">✅</text>
                <text class="status-label">已完成</text>
              </view>
            </view>
          </view>

          <!-- 添加按钮 -->
          <button
            class="add-activity-btn {{ canAddActivity ? '' : 'disabled' }}"
            bindtap="addActivity"
            disabled="{{ !canAddActivity }}"
          >
            <text class="btn-icon">➕</text>
            <text class="btn-text">添加活动</text>
          </button>
        </view>

        <!-- 保存按钮 -->
        <view class="save-section" wx:if="{{ allActivities.length > 0 }}">
          <button
            class="btn btn-primary save-btn"
            bindtap="saveMemo"
            disabled="{{ isSaving }}"
            loading="{{ isSaving }}"
          >
            <text>{{ isSaving ? '保存中...' : '保存记录' }}</text>
          </button>
        </view>
      </view>
    </view>
  </view>
</view>
