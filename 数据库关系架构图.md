# 数据库关系架构图 - 系统化改版

## 📊 核心关系链

```
┌─────────────────────────────────────────────────────────────┐
│                     系统库 (Systems)                         │
│  定义：一个长期运行的习惯系统                                 │
│  例如："每日深度阅读系统"、"健康管理系统"                      │
└─────────────────────────────────────────────────────────────┘
                              ↓ 包含
┌─────────────────────────────────────────────────────────────┐
│                 日常行动库 (Daily Actions)                   │
│  定义：系统中的具体可执行行动                                 │
│  例如："阅读30分钟"、"记录体重"、"运动30分钟"                  │
└─────────────────────────────────────────────────────────────┘
                              ↓ 执行产生
┌─────────────────────────────────────────────────────────────┐
│                  主记录表 (Main Records)                     │
│  定义：某一天执行某个系统的概况记录                           │
│  例如："2025-11-16 执行了深度阅读系统"                       │
└─────────────────────────────────────────────────────────────┘
                              ↓ 详细分解
┌─────────────────────────────────────────────────────────────┐
│                活动明细表 (Activity Details)                 │
│  定义：主记录中每个行动的具体时间投入                         │
│  例如："14:00-14:45 阅读《原则》45分钟"                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔗 详细关系说明

### 1️⃣ 系统库 (Systems)

**定义**：一组日常行动的集合，代表一个长期运行的习惯系统

**示例**：
```javascript
{
  System Name: "每日深度阅读系统",
  Frequency: "每日",
  Category: "个人成长",
  Status: "活跃",
  Current Streak: 15,  // 连续执行15天
  Execution Rate: 88%  // 执行率
}
```

**关联**：
- ← 包含多个 Daily Actions（日常行动）
- → 产生多个 Main Records（主记录）

---

### 2️⃣ 日常行动库 (Daily Actions)

**定义**：系统中的具体可执行行动项，每日重复

**示例**：
```javascript
{
  Action Name: "阅读30分钟",
  Belongs To System: "每日深度阅读系统", // 关联到系统
  Target Type: "时长",
  Target Value: 30,
  Unit: "分钟",
  Recurrence: "每日",
  Status Today: false  // 今日是否已完成
}
```

**关联**：
- ↑ 属于某个 System（系统）
- → 执行时产生 Main Records（主记录）
- → 执行时产生 Activity Details（活动明细）

---

### 3️⃣ 主记录表 (Main Records)

**定义**：某一天执行某个系统的概况记录（改版后的角色）

**改版前**：
```javascript
{
  Title: "今天的备忘录",
  Content: "今天做了很多事...",
  Date: "2025-11-16",
  Record Type: "日常记录"
}
```

**改版后**：
```javascript
{
  Title: "执行深度阅读系统",
  Date: "2025-11-16",
  Executed System: "每日深度阅读系统",  // ⭐ 关联系统
  Executed Actions: [
    "阅读30分钟",
    "记录3个要点"
  ],
  Target Total Minutes: 30,
  Actual Total Minutes: 45,
  Achievement Rate: 150%,
  Quality Rating: 5,  // 5星好评
  Is Target Achieved: true,
  Summary: "今天读了《原则》第三章，收获很大..."
}
```

**关联**：
- ↑ 记录某个 System 的执行情况
- ↑ 记录某些 Daily Actions 的完成情况
- → 详细分解为多个 Activity Details

---

### 4️⃣ 活动明细表 (Activity Details)

**定义**：具体的时间投入详情（精确到分钟）

**示例**：
```javascript
{
  Name: "阅读《原则》",
  Date: "2025-11-16",
  Start Time: "14:00",
  End Time: "14:45",
  Duration: 45,  // 分钟
  Activity Type: "学习",
  Related System: "每日深度阅读系统",     // ⭐ 关联系统
  Related Action: "阅读30分钟",          // ⭐ 关联行动
  Related Main Record: "执行深度阅读系统" // ⭐ 关联主记录
}
```

**关联**：
- ↑ 属于某个 Main Record（主记录）
- ↑ 对应某个 Daily Action（日常行动）
- ↑ 贡献给某个 System（系统）

---

## 🏥 特殊情况：每日状态库 (Daily Status)

**核心问题**：每日状态库应该如何融入系统架构？

### 方案设计：将 Daily Status 视为"健康管理系统"的执行记录

```
┌─────────────────────────────────────────┐
│   Systems（系统库）                      │
│   - 深度阅读系统                         │
│   - 内容创作系统                         │
│   - 健康管理系统 ← ⭐ 特殊系统            │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   Daily Actions（日常行动）              │
│   健康管理系统的行动：                    │
│   - 记录体重                             │
│   - 记录睡眠                             │
│   - 记录心情                             │
│   - 记录运动                             │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│   Main Records（主记录）                 │
│   "2025-11-16 执行健康管理系统"          │
│   ↓ 关联                                │
│   Daily Status（每日状态库）⭐           │
│   - 今日体重: 65kg                      │
│   - 睡眠时长: 7.5h                      │
│   - 心情: 愉悦                          │
│   - 运动时长: 30min                     │
└─────────────────────────────────────────┘
```

### Daily Status 的特殊性

**1. 它是结构化数据记录**
- 不是自由文本，而是固定字段（体重、睡眠、心情等）
- 每天一条记录

**2. 它既独立又关联**
- **独立性**：保留原有的独立数据库，方便健康数据分析
- **关联性**：通过 Main Records 关联到"健康管理系统"

**3. 数据库关系**

```javascript
// Daily Status 数据结构
{
  Date: "2025-11-16",
  Weight: 65,
  Sleep Hours: 7.5,
  Sleep Quality: "良好",
  Mood: ["愉悦", "充实"],
  Energy Level: "充沛",
  Stress Level: "轻度",
  Exercise Minutes: 30,
  Water Cups: 8,

  // ⭐ 新增关联字段
  Related System: "健康管理系统",
  Related Main Record: "2025-11-16 执行健康管理系统"
}
```

```javascript
// Main Record 记录健康系统执行
{
  Title: "执行健康管理系统",
  Date: "2025-11-16",
  Executed System: "健康管理系统",

  // ⭐ 关联 Daily Status
  Related Daily Status: "2025-11-16 健康状态",

  Summary: "今日体重65kg，睡眠良好7.5小时，运动30分钟"
}
```

---

## 📈 完整数据流示例

### 场景：用户在2025-11-16执行了两个系统

#### 系统1：深度阅读系统

```
1. Systems（系统库）
   {
     System Name: "每日深度阅读系统",
     Current Streak: 15
   }

2. Daily Actions（日常行动）
   - 行动A: "阅读30分钟"
   - 行动B: "记录3个要点"

3. Main Records（主记录）
   {
     Date: "2025-11-16",
     Title: "执行深度阅读系统",
     Executed System: "每日深度阅读系统",
     Executed Actions: ["阅读30分钟", "记录3个要点"],
     Actual Total Minutes: 45,
     Achievement Rate: 150%
   }

4. Activity Details（活动明细）
   - 明细1: {
       Name: "阅读《原则》",
       Start: "14:00",
       End: "14:45",
       Duration: 45,
       Related Action: "阅读30分钟"
     }
   - 明细2: {
       Name: "记录阅读要点",
       Start: "14:45",
       End: "14:55",
       Duration: 10,
       Related Action: "记录3个要点"
     }
```

#### 系统2：健康管理系统

```
1. Systems（系统库）
   {
     System Name: "健康管理系统",
     Current Streak: 7
   }

2. Daily Actions（日常行动）
   - 行动A: "记录体重和睡眠"
   - 行动B: "运动30分钟"

3. Main Records（主记录）
   {
     Date: "2025-11-16",
     Title: "执行健康管理系统",
     Executed System: "健康管理系统",
     Related Daily Status: "2025-11-16 健康状态"
   }

4. Daily Status（每日状态）⭐ 特殊
   {
     Date: "2025-11-16",
     Weight: 65,
     Sleep Hours: 7.5,
     Exercise Minutes: 30,
     Related System: "健康管理系统"
   }

5. Activity Details（活动明细）
   - 明细1: {
       Name: "晨跑",
       Start: "07:00",
       End: "07:30",
       Duration: 30,
       Related Action: "运动30分钟"
     }
```

---

## 🔄 数据统计链路

### 系统执行率计算

```
Systems.Execution Rate =
  (过去30天中有 Main Records 的天数) / 30

例如：
- 深度阅读系统：26/30天有记录 = 87%
- 健康管理系统：21/30天有记录 = 70%
```

### 系统总投入时间

```
Systems.Total Time =
  SUM(所有关联的 Activity Details.Duration)

例如：
- 深度阅读系统：
  过去30天所有阅读活动总时长 = 1350分钟
```

### 行动完成率

```
Daily Actions.Completion Rate =
  (过去30天完成次数) / 30

例如：
- "阅读30分钟"：26/30 = 87%
- "记录3个要点"：24/30 = 80%
```

---

## 📋 数据库字段总结

### Systems（系统库）

| 字段 | 类型 | 说明 | 数据来源 |
|------|------|------|----------|
| System Name | Title | 系统名称 | 用户创建 |
| Frequency | Select | 频率 | 用户设置 |
| Current Streak | Number | 连续天数 | 从Main Records计算 |
| Total Executions | Number | 总执行次数 | Main Records计数 |
| Execution Rate | Formula | 执行率 | Total Executions / Days |
| Total Time | Rollup | 总时长 | 汇总Activity Details |

### Daily Actions（日常行动）

| 字段 | 类型 | 说明 | 数据来源 |
|------|------|------|----------|
| Action Name | Title | 行动名称 | 用户创建 |
| Belongs To System | Relation | 所属系统 | 关联Systems |
| Target Value | Number | 目标值 | 用户设置 |
| Status Today | Checkbox | 今日完成 | 从Main Records判断 |
| Current Streak | Number | 连续天数 | 从Main Records计算 |

### Main Records（主记录）⭐ 改版

| 字段 | 类型 | 说明 | 数据来源 |
|------|------|------|----------|
| Title | Title | 标题 | 自动生成"执行XX系统" |
| Date | Date | 日期 | 用户记录 |
| Executed System | Relation | 执行的系统 | 关联Systems |
| Executed Actions | Relation | 执行的行动 | 关联Daily Actions |
| Actual Total Minutes | Number | 实际总时长 | 汇总Activity Details |
| Achievement Rate | Formula | 完成率 | Actual/Target*100% |
| Related Daily Status | Relation | 关联健康数据 | 仅健康系统有 |

### Activity Details（活动明细）⭐ 改版

| 字段 | 类型 | 说明 | 数据来源 |
|------|------|------|----------|
| Name | Title | 活动名称 | 用户记录 |
| Duration | Number | 时长 | 用户记录 |
| Related System | Relation | 关联系统 | 关联Systems |
| Related Action | Relation | 关联行动 | 关联Daily Actions |
| Related Main Record | Relation | 关联主记录 | 关联Main Records |

### Daily Status（每日状态）⭐ 特殊

| 字段 | 类型 | 说明 | 数据来源 |
|------|------|------|----------|
| Date | Date | 日期 | 用户记录 |
| Weight, Sleep等 | Number/Select | 健康数据 | 用户记录 |
| Related System | Relation | 关联系统 | 固定为"健康管理系统" |
| Related Main Record | Relation | 关联主记录 | 自动关联 |

---

## 💡 设计原则

1. **单一数据源**
   - 用户只在一个地方记录数据
   - 所有统计数据自动计算

2. **清晰的层级关系**
   - System（系统）> Daily Action（行动）> Main Record（记录）> Activity Detail（明细）

3. **灵活的关联**
   - 支持一对多关系（一个系统有多个行动）
   - 支持多对多关系（一条主记录可执行多个系统）

4. **Daily Status的特殊处理**
   - 保留独立性，方便健康数据分析
   - 通过关联融入系统框架
   - 既是数据记录，也是系统执行记录

---

## 🎯 总结

**核心关系链**：
```
Systems（定义做什么）
    ↓
Daily Actions（具体怎么做）
    ↓
Main Records（今天做了什么）
    ↓
Activity Details（详细时间投入）
```

**Daily Status的位置**：
```
Daily Status =
  健康管理系统的特殊执行记录
  + 独立的结构化健康数据库
```

这样设计的好处：
- ✅ 统一的系统化架构
- ✅ 清晰的数据关系
- ✅ 自动化的统计计算
- ✅ 灵活的扩展性

---

*设计日期：2025年11月16日*
