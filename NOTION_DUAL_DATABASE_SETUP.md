# Notion双数据库架构配置指南

## 🎯 **架构概述**

新的Notion双数据库架构将记录和时间投入分离存储，实现更好的数据规范化和查询性能：

```
主记录数据库 (memo_records)
    ↓ 一对多关系
时间投入数据库 (time_investments)
```

## 🔧 **配置步骤**

### ⚡ **自动配置（推荐）**

当您首次配置Notion集成时，系统会自动尝试创建时间投入子数据库：

1. 在小程序设置页面输入Notion API Key和主记录数据库ID
2. 点击"测试连接"
3. 系统会自动检测主数据库的父页面位置
4. 在同一页面下自动创建"时间投入记录"子数据库
5. 自动配置数据库关联关系

如果自动创建成功，您会看到"✅ 时间投入数据库创建成功"的提示。

### 🛠 **手动配置（备选方案）**

如果自动创建失败（通常是权限问题），请按照以下步骤手动创建：

### **第一步：创建主记录数据库**

在Notion中创建主记录数据库，包含以下字段：

| 字段名 | 类型 | 用途 | 必需 |
|--------|------|------|------|
| `title` | Title | 记录标题 | ✅ |
| `content` | Rich Text | 记录内容 | ✅ |
| `user_id` | Rich Text | 用户ID | ✅ |
| `type` | Select | 记录类型 (text/voice) | ✅ |
| `is_planning` | Checkbox | 是否为规划记录 | ✅ |
| `tags` | Multi-select | 标签 | ⚪ |
| `sync_status` | Select | 同步状态 | ⚪ |
| `audio_url` | URL | 语音文件链接 | ⚪ |

### **第二步：创建时间投入子记录数据库**

在Notion中创建时间投入数据库，包含以下字段：

| 字段名 | 类型 | 用途 | 配置 |
|--------|------|------|------|
| `activity_name` | Title | 活动名称 | ✅ |
| `memo_record` | Relation | 关联主记录 | **关联到主记录数据库** |
| `minutes` | Number | 投入分钟数 | ✅ |
| `value_category` | Select | 价值分类 | 选项: valuable, wasteful |
| `user_id` | Rich Text | 用户ID | ✅ |
| `record_date` | Date | 记录日期 | ✅ |
| `created_at` | Created time | 创建时间 | 自动生成 |

### **第三步：配置关联关系**

1. **在时间投入数据库中**：
   - 添加 `memo_record` 字段，类型选择 **Relation**
   - 关联目标选择主记录数据库
   - 允许多个时间投入记录关联同一个主记录

2. **在主记录数据库中**：
   - 会自动生成反向关联字段
   - 可以查看每个记录的所有时间投入

### **第四步：获取数据库ID**

1. **主记录数据库ID**：
   ```
   https://notion.so/your-workspace/[DATABASE_ID]?v=...
                                   ^^^^^^^^^^^^^^^^
   ```

2. **时间投入数据库ID**：
   ```
   https://notion.so/your-workspace/[TIME_INVESTMENT_DATABASE_ID]?v=...
                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   ```

### **第五步：更新用户配置**

在小程序设置中添加时间投入数据库ID配置：

```javascript
// 用户配置结构
{
  notionConfig: {
    enabled: true,
    apiKey: "YOUR_NOTION_API_KEY",
    databaseId: "YOUR_MAIN_DATABASE_ID",
    timeInvestmentDatabaseId: "YOUR_TIME_INVESTMENT_DATABASE_ID", // 新增
    syncEnabled: true
  }
}
```

## 📊 **数据示例**

### **主记录示例**
```
标题: 今天的学习和工作记录
内容: 
## 🌟 有价值的活动
学习了新的编程技巧
完成了项目的核心功能

## 🗑️ 低效的活动
刷手机看视频

---
时间投入统计: 有价值活动: 90分钟, 低效活动: 15分钟
```

### **时间投入子记录示例**
```
记录1:
- 活动名称: 编程
- 关联记录: [链接到主记录]
- 投入时间: 60分钟
- 价值分类: valuable
- 记录日期: 2025-01-07

记录2:
- 活动名称: 学习
- 关联记录: [链接到主记录]  
- 投入时间: 30分钟
- 价值分类: valuable
- 记录日期: 2025-01-07

记录3:
- 活动名称: 刷手机
- 关联记录: [链接到主记录]
- 投入时间: 15分钟
- 价值分类: wasteful
- 记录日期: 2025-01-07
```

## 🎯 **核心优势**

### **1. 数据规范化**
- ✅ 相同活动名称自动标准化（"写代码" → "编程"）
- ✅ 避免重复存储相同信息
- ✅ 便于活动分类和统计

### **2. 高效查询**
- ✅ Notion原生关联比JSON解析更快
- ✅ 可以独立查询时间投入统计
- ✅ 支持复杂的筛选和聚合

### **3. 扩展性强**
- ✅ 后续可添加活动难度、目标关联等字段
- ✅ 可以建立活动分类体系
- ✅ 支持更复杂的时间分析

### **4. 管理便利**
- ✅ 可以在Notion中直观查看数据关联
- ✅ 便于数据清理和维护
- ✅ 支持Notion的强大筛选功能

## 📈 **查询示例**

### **查看某个记录的时间投入**
在主记录中点击关联字段，可以看到所有相关的时间投入详情。

### **统计某个活动的总时间**
在时间投入数据库中：
1. 按 `activity_name` 分组
2. 对 `minutes` 求和
3. 按时间排序

### **分析时间投入趋势**
在时间投入数据库中：
1. 按 `record_date` 和 `value_category` 筛选
2. 统计每日有价值/无价值时间比例
3. 生成趋势图表

## ⚠️ **注意事项**

1. **API权限**：确保Notion API Token有两个数据库的读写权限
2. **数据同步**：主记录和子记录的同步是按顺序进行的
3. **错误处理**：子记录同步失败不会影响主记录的保存
4. **数据清理**：删除主记录时，相关的时间投入记录需要手动清理

## 🚀 **未来扩展**

1. **活动主数据管理**：建立标准活动库，进一步规范化
2. **智能分类**：基于AI的活动自动分类
3. **时间预测**：基于历史数据预测任务耗时
4. **效率分析**：跨时间段的效率对比分析

---

**配置完成后，您的时间记录将享受专业级的数据库架构带来的强大功能！** 🎉