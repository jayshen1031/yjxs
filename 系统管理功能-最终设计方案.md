# 系统管理功能 - 最终设计方案

## 🎯 核心理念

**通过系统实现目标**：关注每日执行，而非目标完成度

---

## 📊 数据库架构简化

### 删除：Main Records（主记录表）

**原因**：
- 与 Activity Details 功能重复
- 增加数据维护复杂度
- 用户只需要记录活动明细即可

### 保留并增强：Activity Details（活动明细表）

**定位**：唯一的记录表，记录所有活动

---

## 🗄️ 数据库字段设计

### 1. Goals（目标库）- 增加系统管理字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| Goal Name | Title | 目标名称 |
| Target Hours | Number | 目标总时长 |
| Current Hours | Number | 当前累计时长 |
| Progress | Formula | 进度 = Current/Target*100% |
| **Is System Managed** | Checkbox | ⭐ 是否加入系统管理 |
| **Daily Target Hours** | Number | ⭐ 每日目标时长 |

**示例**：
```javascript
{
  Goal Name: "N2日语能力考试",
  Target Hours: 500,
  Current Hours: 120,
  Progress: 24%,
  Is System Managed: true,      // ⭐ 勾选后显示在足迹页面
  Daily Target Hours: 2          // ⭐ 每天目标2小时
}
```

---

### 2. Todos（待办库）- 增加系统管理字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| Title | Title | 待办名称 |
| Total Target Count | Number | 总目标次数 |
| Current Count | Number | 当前完成次数 |
| **Is System Managed** | Checkbox | ⭐ 是否加入系统管理 |
| **Daily Target Count** | Number | ⭐ 每日目标次数 |

**示例**：
```javascript
{
  Title: "每日阅读",
  Total Target Count: 100,
  Current Count: 45,
  Is System Managed: true,       // ⭐ 勾选后显示在足迹页面
  Daily Target Count: 3          // ⭐ 每天目标3次
}
```

---

### 3. Activity Details（活动明细表）- 增强字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| Date | Date | 日期 |
| Activity Name | Title | 活动名称 |
| Start Time | Text | 开始时间（HH:MM） |
| End Time | Text | 结束时间（HH:MM） |
| Duration | Number | 时长（分钟） |
| Activity Type | Select | 活动类型 |
| Related Goal | Relation | 关联目标（可选） |
| Related Todo | Relation | 关联待办（可选） |
| **Related Knowledge** | Relation | ⭐ 关联知识库（可选） |
| **Todo Completion Count** | Number | ⭐ 待办完成次数（默认1） |

**示例1：系统管理目标的记录**
```javascript
{
  Date: "2025-11-16",
  Activity Name: "学习日语语法第三章",
  Start Time: "14:00",
  End Time: "16:00",
  Duration: 120,
  Activity Type: "学习",
  Related Goal: "N2日语能力考试",
  Related Knowledge: "日语学习笔记"
}
```

**示例2：系统管理待办的记录**
```javascript
{
  Date: "2025-11-16",
  Activity Name: "阅读《原则》",
  Start Time: "07:00",
  End Time: "07:20",
  Duration: 20,
  Activity Type: "学习",
  Related Todo: "每日阅读",
  Todo Completion Count: 1,
  Related Knowledge: "读书笔记"
}
```

**示例3：普通流水账**
```javascript
{
  Date: "2025-11-16",
  Activity Name: "喝咖啡聊天",
  Start Time: "10:00",
  End Time: "11:30",
  Duration: 90,
  Activity Type: "社交",
  // 不关联任何目标/待办/知识库
}
```

---

## 📱 足迹记录页面设计

### 页面结构

```
┌─ 📅 2025年11月16日 ───────────────────────┐
│                                            │
│ 🎯 系统管理项（自动加载）                   │
│ ┌──────────────────────────────────────┐ │
│ │ 名称        │ 日目标 │ 今日 │ 总进度 │ │
│ ├──────────────────────────────────────┤ │
│ │ 📚 N2日语   │ 2.0h  │ 0.0h │ 120/500│ │
│ │             │       │ [+记录]        │ │
│ ├──────────────────────────────────────┤ │
│ │ ✅ 每日阅读 │ 3次   │ ✅1次│ 45/100 │ │
│ │             │       │ [+记录]        │ │
│ ├──────────────────────────────────────┤ │
│ │ 💪 减重10斤 │ 1.0h  │ ✅0.5h│ 25/100│ │
│ │             │       │ [+记录]        │ │
│ └──────────────────────────────────────┘ │
│                                            │
│ 📝 今日活动明细                             │
│ 14:00-16:00 学习日语语法(120min)           │
│             🎯N2日语 📚日语学习笔记         │
│                                            │
│ 07:00-07:20 阅读《原则》(20min)            │
│             ✅每日阅读 📚读书笔记           │
│                                            │
│ 10:00-11:30 喝咖啡聊天(90min)              │
│                                            │
│ [+ 新增其他活动]                            │
└────────────────────────────────────────────┘
```

### 功能说明

#### 1. 系统管理项表格（自动加载）

**数据来源**：
- 查询所有 `Is System Managed = true` 的 Goals
- 查询所有 `Is System Managed = true` 的 Todos
- 按类型分组显示

**今日统计**：
- 从当日的 Activity Details 中汇总
- Goals：汇总 Duration（转换为小时）
- Todos：汇总 Todo Completion Count

**显示逻辑**：
```javascript
// 伪代码
const systemGoals = Goals.filter(g => g.Is_System_Managed === true)
const systemTodos = Todos.filter(t => t.Is_System_Managed === true)

systemGoals.forEach(goal => {
  const todayActivities = ActivityDetails.filter(a =>
    a.Date === today && a.Related_Goal === goal.id
  )
  const todayHours = sum(todayActivities.map(a => a.Duration)) / 60

  displayRow({
    name: goal.Goal_Name,
    dailyTarget: goal.Daily_Target_Hours + 'h',
    today: todayHours + 'h',
    total: goal.Current_Hours + '/' + goal.Target_Hours
  })
})
```

#### 2. 快速记录功能（点击表格中的 [+记录]）

**弹窗内容**：

```
┌─ 快速记录 ──────────────────┐
│ 目标：📚 N2日语              │
│                             │
│ 时间段：                     │
│ 开始：[14] : [00]           │
│ 结束：[16] : [00]           │
│ 时长：2.0小时（自动计算）     │
│                             │
│ 活动说明：                   │
│ [学习日语语法第三章]         │
│                             │
│ 关联知识库（可选）：         │
│ [选择知识库 ▼]              │
│   □ 日语学习笔记             │
│   □ 工作笔记                 │
│   □ 读书笔记                 │
│                             │
│ [保存] [取消]               │
└─────────────────────────────┘
```

**保存逻辑**：
1. 创建 Activity Details 记录
2. 更新 Goal.Current Hours += duration/60
3. 刷新表格显示

**待办型记录弹窗**：

```
┌─ 快速记录 ──────────────────┐
│ 待办：✅ 每日阅读            │
│                             │
│ 完成次数：[1] 次            │
│                             │
│ 时间段：                     │
│ 开始：[07] : [00]           │
│ 结束：[07] : [20]           │
│ 时长：20分钟（自动计算）      │
│                             │
│ 活动说明：                   │
│ [阅读《原则》第三章]         │
│                             │
│ 关联知识库（可选）：         │
│ [选择知识库 ▼]              │
│                             │
│ [保存] [取消]               │
└─────────────────────────────┘
```

**保存逻辑**：
1. 创建 Activity Details 记录
2. 更新 Todo.Current Count += Todo_Completion_Count
3. 刷新表格显示

#### 3. 新增其他活动（流水账）

**点击 [+ 新增其他活动] 弹窗**：

```
┌─ 新增活动 ──────────────────┐
│ 活动名称：                   │
│ [喝咖啡聊天]                │
│                             │
│ 时间段：                     │
│ 开始：[10] : [00]           │
│ 结束：[11] : [30]           │
│ 时长：1.5小时（自动计算）     │
│                             │
│ 活动类型：                   │
│ [社交 ▼]                    │
│   - 学习                     │
│   - 工作                     │
│   - 运动                     │
│   - 社交                     │
│   - 休闲                     │
│   - 其他                     │
│                             │
│ 关联目标（可选）：           │
│ [选择目标 ▼]                │
│                             │
│ 关联待办（可选）：           │
│ [选择待办 ▼]                │
│                             │
│ 关联知识库（可选）：         │
│ [选择知识库 ▼]              │
│                             │
│ [保存] [取消]               │
└─────────────────────────────┘
```

**保存逻辑**：
1. 创建 Activity Details 记录
2. 如果关联了目标，更新 Goal.Current Hours
3. 如果关联了待办，更新 Todo.Current Count
4. 刷新活动列表

---

## 🎯 目标/待办编辑页面改造

### Goals 编辑页面增加系统管理选项

```
┌─ 编辑目标 ────────────────────┐
│ 目标名称：                     │
│ [N2日语能力考试]              │
│                               │
│ 目标时长：                     │
│ [500] 小时                    │
│                               │
│ 当前进度：                     │
│ 120/500 小时 (24%)           │
│                               │
│ ─────────────────────────     │
│ ⭐ 系统管理设置                │
│                               │
│ ☑️ 加入系统管理                │
│    勾选后会在足迹页面显示       │
│                               │
│ 每日目标时长：                 │
│ [2.0] 小时                    │
│                               │
│ [保存] [取消]                 │
└───────────────────────────────┘
```

### Todos 编辑页面增加系统管理选项

```
┌─ 编辑待办 ────────────────────┐
│ 待办名称：                     │
│ [每日阅读]                    │
│                               │
│ 总目标次数：                   │
│ [100] 次                      │
│                               │
│ 当前进度：                     │
│ 45/100 次 (45%)              │
│                               │
│ ─────────────────────────     │
│ ⭐ 系统管理设置                │
│                               │
│ ☑️ 加入系统管理                │
│    勾选后会在足迹页面显示       │
│                               │
│ 每日目标次数：                 │
│ [3] 次                        │
│                               │
│ [保存] [取消]                 │
└───────────────────────────────┘
```

---

## 🔄 数据流向

### 记录系统管理目标

```
用户点击 [+记录]
    ↓
弹出快速记录窗
    ↓
填写时间段、活动说明、关联知识库
    ↓
点击保存
    ↓
① 创建 Activity Details
   - Date: 2025-11-16
   - Activity Name: "学习日语语法第三章"
   - Start Time: "14:00"
   - End Time: "16:00"
   - Duration: 120
   - Related Goal: "N2日语"
   - Related Knowledge: "日语学习笔记"
    ↓
② 更新 Goal
   - Current Hours: 120 → 122
   - Progress: 24% → 24.4%
    ↓
③ 刷新足迹页面
   - 系统管理项表格：今日 0.0h → 2.0h
   - 活动明细列表：新增一条记录
```

### 记录系统管理待办

```
用户点击 [+记录]
    ↓
弹出快速记录窗
    ↓
填写完成次数、时间段、活动说明
    ↓
点击保存
    ↓
① 创建 Activity Details
   - Date: 2025-11-16
   - Activity Name: "阅读《原则》"
   - Duration: 20
   - Related Todo: "每日阅读"
   - Todo Completion Count: 1
   - Related Knowledge: "读书笔记"
    ↓
② 更新 Todo
   - Current Count: 45 → 46
   - Progress: 45% → 46%
    ↓
③ 刷新足迹页面
   - 系统管理项表格：今日 0次 → 1次
   - 活动明细列表：新增一条记录
```

---

## 📂 需要修改的文件

### 1. 数据库架构

- `utils/notionDatabaseSetup.js`
  - Goals 增加字段：Is System Managed, Daily Target Hours
  - Todos 增加字段：Is System Managed, Daily Target Count, Total Target Count, Current Count
  - Activity Details 增加字段：Related Knowledge, Todo Completion Count
  - 删除 Main Records 定义

### 2. 目标/待办编辑

- `pages/goals-todos/goals-todos.wxml`
  - 编辑目标时增加系统管理勾选框
  - 编辑待办时增加系统管理勾选框

- `pages/goals-todos/goals-todos.js`
  - 保存目标时包含系统管理字段
  - 保存待办时包含系统管理字段

### 3. 足迹记录页面

- `pages/history/history.wxml`
  - 增加系统管理项表格
  - 活动明细显示关联的目标/待办/知识库
  - 新增活动按钮

- `pages/history/history.js`
  - 加载系统管理项（Goals + Todos）
  - 计算今日统计
  - 快速记录功能
  - 新增活动功能

- `pages/history/history.wxss`
  - 系统管理项表格样式
  - 活动明细关联标签样式

### 4. Notion API 服务

- `utils/notionApiService.js`
  - 查询系统管理目标/待办
  - 更新目标进度
  - 更新待办进度
  - 查询知识库列表

### 5. 删除 Main Records 相关

- `pages/memo/memo.js` - 删除创建主记录的代码
- `cloudfunctions/memo-notion-sync/index.js` - 删除主记录相关云函数
- 所有引用 Main Records 的地方

---

## ✅ 优势总结

1. **架构简化**：
   - 删除冗余的 Main Records
   - Activity Details 作为唯一数据源
   - 数据流向清晰

2. **用户体验**：
   - 自动加载系统管理项
   - 快速记录，3步完成
   - 流水账记录灵活简单

3. **知识沉淀**：
   - 每个活动都可关联知识库
   - 方便后续回顾和学习

4. **统计准确**：
   - 保留时间段，方便分析时间分布
   - 自动汇总今日进度
   - 自动更新总进度

---

## 🚀 实施步骤

1. **第一阶段**：数据库字段修改
   - Goals/Todos 增加系统管理字段
   - Activity Details 增加关联知识库字段

2. **第二阶段**：目标/待办编辑页面
   - 增加系统管理勾选框
   - 测试保存功能

3. **第三阶段**：足迹页面改造
   - 系统管理项表格
   - 快速记录功能
   - 新增活动功能

4. **第四阶段**：清理 Main Records
   - 删除相关代码
   - 数据迁移（如有必要）

---

*设计日期：2025年11月16日*
