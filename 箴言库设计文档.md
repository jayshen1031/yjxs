# 📚 箴言库（Quotes Database）设计文档

## 概述

箴言库是语寄心声小程序的核心功能之一，用于管理每日箴言、励志语录和人生格言。系统支持从Notion云端同步箴言，并提供丰富的分类、统计和管理功能。

## 数据库架构

### Notion数据库字段

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| **Quote** | Title | 箴言内容（主要字段） | ✅ |
| **Author** | Rich Text | 作者/来源 | ❌ |
| **Source** | Rich Text | 出处（书籍、电影、演讲等） | ❌ |
| **Category** | Select | 分类标签 | ❌ |
| **Tags** | Multi Select | 多个标签 | ❌ |
| **Status** | Select | 使用状态 | ✅ |
| **Is System Default** | Checkbox | 是否为系统默认箴言 | ✅ |
| **Display Count** | Number | 展示次数 | ❌ |
| **Last Displayed Date** | Date | 最后展示日期 | ❌ |
| **Created Date** | Date | 创建日期 | ❌ |
| **User ID** | Rich Text | 用户标识 | ❌ |
| **Notes** | Rich Text | 备注 | ❌ |

### 分类选项（Category）

1. **励志** - 激励人心的箴言
2. **人生** - 人生感悟类
3. **成长** - 个人成长相关
4. **时间** - 时间管理相关
5. **坚持** - 关于坚持的箴言
6. **记录** - 记录相关
7. **感悟** - 深度思考
8. **习惯** - 习惯养成
9. **梦想** - 梦想追求

### 标签选项（Tags）

- 正能量
- 深度思考
- 轻松
- 哲理
- 实用
- 情感

### 状态选项（Status）

- **启用** - 正常显示在箴言池中
- **禁用** - 暂时不显示
- **收藏** - 用户收藏的箴言

## 核心功能

### 1. 箴言加载（loadQuotesFromNotion）

**功能**：从Notion加载用户的箴言库

**流程**：
```
1. 检查用户Notion配置
2. 查询Status='启用'的箴言
3. 解析Notion数据为箴言对象
4. 合并系统默认箴言
5. 返回完整箴言列表
```

**降级策略**：
- 如果Notion未配置 → 使用系统默认箴言（15条）
- 如果Notion箴言库为空 → 使用系统默认箴言
- 如果加载失败 → 使用系统默认箴言

### 2. 每日箴言选择（selectDailyQuote）

**支持两种策略**：

#### 策略1：随机选择（random）
- 基于当天日期生成种子
- 确保同一天显示相同箴言
- 代码实现：
```javascript
const today = new Date().toDateString()
const seed = today.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)
const index = seed % quotes.length
return quotes[index]
```

#### 策略2：最少展示（least_displayed）
- 选择展示次数最少的箴言
- 确保所有箴言都有展示机会
- 适合用户自定义箴言较多的场景

### 3. 展示统计更新（updateQuoteDisplayStats）

**功能**：记录箴言的展示次数和最后展示日期

**更新内容**：
- Display Count +1
- Last Displayed Date = 今天

**用途**：
- 支持"最少展示"策略
- 统计箴言使用频率
- 分析用户偏好

### 4. 箴言库初始化（initializeQuotesDatabase）

**功能**：将系统默认的15条箴言导入到用户的Notion数据库

**使用场景**：
- 新用户首次配置Notion
- 用户箴言库为空需要初始化
- 恢复默认箴言

**导入内容**：
- 15条系统默认箴言
- 自动设置Status='启用'
- 标记Is System Default=true
- 初始化Display Count=0

### 5. 自定义箴言添加（addCustomQuote）

**功能**：用户添加自己的箴言到Notion

**支持字段**：
- quote（必填）- 箴言内容
- author（可选）- 作者
- source（可选）- 出处
- category（可选）- 分类
- tags（可选）- 标签数组

## 系统默认箴言

系统内置15条箴言，涵盖励志、记录、成长等多个主题：

1. "今天的努力，是为了明天的惊喜。" - 励志
2. "记录生活的美好，让每个瞬间都有意义。" - 记录
3. "时间是最好的见证者，坚持是最美的回答。" - 坚持
4. "每一个小小的记录，都是成长的足迹。" - 成长
5. "用心感受每一刻，让平凡的日子闪闪发光。" - 人生
6. "善待时光，善待自己，记录属于你的故事。" - 时间
7. "不是每天都有新鲜事，但每天都值得记录。" - 记录
8. "生活不在于长短，而在于是否精彩。" - 人生
9. "用文字定格时光，用声音留住回忆。" - 记录
10. "每个今天，都是明天的珍贵回忆。" - 时间
11. "保持好奇心，记录发现的惊喜。" - 成长
12. "小小的坚持，会带来大大的改变。" - 坚持
13. "今天比昨天进步一点点，就是成功。" - 成长
14. "记录是为了更好地前行。" - 记录
15. "在平凡中发现不平凡，在记录中找到意义。" - 感悟

## 技术实现

### 文件结构

```
utils/
├── quoteService.js           # 箴言管理服务
├── notionDatabaseSetup.js    # 数据库Schema定义
└── notionApiService.js       # Notion API调用

app.js                        # 全局箴言加载和选择

pages/
├── home/home.js              # 首页箴言显示
├── notion-config/            # Notion配置页面
│   ├── notion-config.js
│   ├── notion-config.wxml
│   └── notion-config.wxss
└── quote-manager/            # 箴言管理页面（待实现）
```

### 数据流程

```
启动应用
    ↓
app.onLaunch()
    ↓
loadWisdomQuotes() - 从Notion加载箴言库
    ↓
setDailyQuote() - 选择今日箴言
    ↓
updateQuoteDisplayStats() - 更新展示统计
    ↓
首页显示今日箴言
```

### API接口

#### quoteService.loadQuotesFromNotion()
```javascript
返回: Promise<Array<Quote>>

Quote对象结构:
{
  id: string,              // Notion页面ID
  quote: string,           // 箴言内容
  author: string,          // 作者
  source: string,          // 出处
  category: string,        // 分类
  tags: string[],          // 标签数组
  displayCount: number,    // 展示次数
  lastDisplayedDate: string, // 最后展示日期
  isSystemDefault: boolean // 是否系统默认
}
```

#### quoteService.selectDailyQuote(quotes, strategy)
```javascript
参数:
- quotes: Array<Quote> - 箴言列表
- strategy: 'random' | 'least_displayed' - 选择策略

返回: Quote - 今日箴言对象
```

#### quoteService.updateQuoteDisplayStats(quoteId)
```javascript
参数:
- quoteId: string - 箴言的Notion页面ID

返回: Promise<void>
```

#### quoteService.initializeQuotesDatabase()
```javascript
返回: Promise<{
  success: boolean,
  total: number,
  imported: number,
  error?: string
}>
```

#### quoteService.addCustomQuote(quoteData)
```javascript
参数:
- quoteData: {
    quote: string,       // 必填
    author?: string,
    source?: string,
    category?: string,
    tags?: string[]
  }

返回: Promise<{
  success: boolean,
  data?: Page,
  error?: string
}>
```

## 配置说明

### 1. Notion API Key
在Notion配置页面输入您的Integration Token

### 2. 箴言库数据库ID
1. 在Notion中创建一个数据库
2. 按照Schema定义配置字段
3. 复制数据库ID（从URL中获取）
4. 在配置页面输入

### 3. 初始化箴言库
首次配置后，建议：
1. 调用`initializeQuotesDatabase()`导入系统默认箴言
2. 或手动在Notion中添加自己的箴言
3. 确保至少有一条Status='启用'的箴言

## 使用场景

### 场景1：新用户首次使用
1. 用户注册登录
2. 系统使用15条默认箴言
3. 用户配置Notion（可选）
4. 初始化箴言库到Notion
5. 开始使用云端箴言

### 场景2：老用户每日使用
1. 用户打开应用
2. 系统检查是否新的一天
3. 如果是新的一天：
   - 选择今日箴言
   - 更新展示统计
   - 保存到本地缓存
4. 首页显示今日箴言

### 场景3：用户添加自定义箴言
1. 用户进入箴言管理页面
2. 点击"添加箴言"
3. 填写箴言内容、作者、分类等
4. 保存到Notion
5. 下次加载时自动包含新箴言

## 扩展功能（待实现）

### 1. 箴言管理页面
- [ ] 查看所有箴言列表
- [ ] 编辑箴言内容
- [ ] 删除箴言
- [ ] 切换启用/禁用状态
- [ ] 收藏箴言
- [ ] 查看展示统计

### 2. 箴言分享
- [ ] 生成精美的箴言卡片
- [ ] 分享到微信好友/朋友圈
- [ ] 保存箴言图片

### 3. 箴言分类浏览
- [ ] 按分类筛选箴言
- [ ] 按标签筛选箴言
- [ ] 搜索箴言内容

### 4. 智能推荐
- [ ] 根据用户偏好推荐箴言
- [ ] 根据当天心情推荐
- [ ] 根据目标进展推荐

### 5. 箴言提醒
- [ ] 设置每日固定时间显示箴言
- [ ] 推送通知展示箴言

## 最佳实践

1. **分类规范**：箴言添加时选择准确的分类，便于后续筛选
2. **标签使用**：可以给一条箴言添加多个标签，提高检索效率
3. **作者信息**：尽量填写作者和出处，增加箴言的可信度
4. **定期清理**：禁用不再喜欢的箴言，保持箴言库质量
5. **展示统计**：定期查看展示统计，了解哪些箴言最受欢迎

## 技术亮点

1. **降级策略**：Notion未配置时自动使用系统默认箴言
2. **双向同步**：本地缓存 + Notion云端存储
3. **智能选择**：支持多种箴言选择策略
4. **展示统计**：自动记录箴言使用频率
5. **灵活扩展**：易于添加新的分类、标签和字段

---

**开发者**: Claude Code
**创建日期**: 2025-10-19
**版本**: v1.0
